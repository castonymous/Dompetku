<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>iFinance Ultra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&family=Inter:wght@400;600&display=swap');

        /* --- THEME VARS --- */
        :root {
            --bg-body: #000000;
            --text-primary: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent: #4f46e5;
        }
        
        [data-theme="light"] {
            --bg-body: #f3f4f6;
            --text-primary: #1f2937;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.05);
            --accent: #4f46e5;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 110px;
            padding-top: env(safe-area-inset-top);
            transition: background-color 0.3s, color 0.3s;
            user-select: none; -webkit-user-select: none;
        }

        input, textarea, select { -webkit-user-select: text; user-select: text; }

        /* Fluid Background */
        .ambient-light {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1;
            background: radial-gradient(circle at 10% 20%, rgba(68, 55, 255, 0.2) 0%, transparent 40%),
                        radial-gradient(circle at 90% 80%, rgba(255, 48, 100, 0.15) 0%, transparent 40%);
            filter: blur(60px); opacity: 0.8;
        }

        /* Components */
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(20px); border-bottom: 1px solid var(--glass-border); }
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); transition: transform 0.2s; }
        .glass-card:active { transform: scale(0.98); }
        .glass-input { 
            background: rgba(128, 128, 128, 0.1); 
            border: 1px solid var(--glass-border); 
            color: var(--text-primary); 
            width: 100%; outline: none; 
        }
        
        .dock { 
            background: rgba(20, 20, 20, 0.9); 
            backdrop-filter: blur(25px); 
            border-top: 1px solid var(--glass-border); 
            padding-bottom: max(15px, env(safe-area-inset-bottom)); 
        }
        [data-theme="light"] .dock { background: rgba(255, 255, 255, 0.9); border-top: 1px solid #e5e7eb; }

        .nav-item { transition: 0.3s; opacity: 0.5; }
        .nav-item.active { opacity: 1; transform: translateY(-2px); color: var(--accent); }
        .blur-amount { filter: blur(6px); }
        .brand-logo { width: 100%; height: 100%; object-fit: contain; border-radius: 50%; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Lock Screen */
        #lock-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: var(--bg-body);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.3s ease-in-out;
        }
        #lock-screen.hidden { display: none !important; }
        
        .pin-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--text-primary); transition: 0.2s; }
        .pin-dot.filled { background: var(--text-primary); }
    </style>
</head>
<body data-theme="dark">

    <div class="ambient-light"></div>

    <!-- LOCK SCREEN -->
    <div id="lock-screen" class="hidden">
        <div class="mb-8 text-center">
            <i class="fa-brands fa-apple text-4xl mb-4"></i>
            <h2 class="text-xl font-bold">iFinance Secured</h2>
            <p class="text-xs opacity-60 mt-1">Masukkan PIN Default: 1234</p>
        </div>
        <div class="flex gap-4 mb-10">
            <div class="pin-dot" id="dot-1"></div>
            <div class="pin-dot" id="dot-2"></div>
            <div class="pin-dot" id="dot-3"></div>
            <div class="pin-dot" id="dot-4"></div>
        </div>
        <div class="grid grid-cols-3 gap-6 text-2xl font-bold">
            <button onclick="enterPin(1)" class="w-16 h-16 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center">1</button>
            <button onclick="enterPin(2)" class="w-16 h-16 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center">2</button>
            <button onclick="enterPin(3)" class="w-16 h-16 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center">3</button>
            <button onclick="enterPin(4)" class="w-16 h-16 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center">4</button>
            <button onclick="enterPin(5)" class="w-16 h-16 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center">5</button>
            <button onclick="enterPin(6)" class="w-16 h-16 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center">6</button>
            <button onclick="enterPin(7)" class="w-16 h-16 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center">7</button>
            <button onclick="enterPin(8)" class="w-16 h-16 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center">8</button>
            <button onclick="enterPin(9)" class="w-16 h-16 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center">9</button>
            <div class="flex items-center justify-center"><button onclick="emergencyReset()" class="text-[10px] text-red-500 font-bold opacity-50 hover:opacity-100">RESET<br>DATA</button></div>
            <button onclick="enterPin(0)" class="w-16 h-16 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center">0</button>
            <button onclick="clearPin()" class="w-16 h-16 flex items-center justify-center text-xl"><i class="fa-solid fa-delete-left"></i></button>
        </div>
    </div>

    <!-- HEADER -->
    <header class="sticky top-0 z-40 pt-4 pb-2 px-5 glass-panel rounded-b-3xl mb-4">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-cyan-500 flex items-center justify-center shadow-lg shadow-indigo-500/30 text-white">
                    <i class="fa-brands fa-apple text-xl"></i>
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <h1 class="font-bold text-lg tracking-tight">iFinance</h1>
                        <button onclick="openSettings()" class="w-6 h-6 rounded-full bg-gray-500/20 flex items-center justify-center text-[10px] hover:bg-gray-500/40 transition">
                            <i class="fa-solid fa-gear"></i>
                        </button>
                    </div>
                    <p class="text-[10px] opacity-60 uppercase tracking-widest">Ultra Edition</p>
                </div>
            </div>
            <div class="text-right">
                <div class="flex items-center justify-end gap-2 mb-1">
                    <p class="text-xs opacity-60">Net Worth</p>
                    <button onclick="togglePrivacy()" class="opacity-60 hover:opacity-100 transition"><i id="privacy-icon" class="fa-solid fa-eye"></i></button>
                </div>
                <h2 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-400 amount-display" id="header-net-worth">Rp 0</h2>
            </div>
        </div>
    </header>

    <main class="px-4 min-h-screen">
        
        <!-- DASHBOARD -->
        <div id="view-dashboard" class="space-y-5 animate-fade-in">
            
            <!-- Quick Transactions -->
            <div class="flex gap-3">
                <button onclick="openTransactionModal('in')" class="flex-1 bg-emerald-500/10 border border-emerald-500/30 py-3 rounded-2xl flex flex-col items-center justify-center hover:bg-emerald-500/20 transition">
                    <i class="fa-solid fa-arrow-down text-emerald-400 mb-1"></i>
                    <span class="text-xs font-bold text-emerald-400">Masuk</span>
                </button>
                <button onclick="openTransactionModal('out')" class="flex-1 bg-rose-500/10 border border-rose-500/30 py-3 rounded-2xl flex flex-col items-center justify-center hover:bg-rose-500/20 transition">
                    <i class="fa-solid fa-arrow-up text-rose-400 mb-1"></i>
                    <span class="text-xs font-bold text-rose-400">Keluar</span>
                </button>
            </div>

            <!-- Quick Templates -->
            <div>
                <p class="text-[10px] uppercase font-bold opacity-50 mb-2 ml-1">Quick Add</p>
                <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                    <button onclick="quickAdd('Kopi', 20000, 'out')" class="bg-amber-600/20 border border-amber-600/30 px-4 py-2 rounded-full whitespace-nowrap text-xs font-bold text-amber-500 flex items-center gap-1">‚òï 20K</button>
                    <button onclick="quickAdd('Makan Siang', 30000, 'out')" class="bg-orange-600/20 border border-orange-600/30 px-4 py-2 rounded-full whitespace-nowrap text-xs font-bold text-orange-500 flex items-center gap-1">üçõ 30K</button>
                    <button onclick="quickAdd('Bensin', 25000, 'out')" class="bg-blue-600/20 border border-blue-600/30 px-4 py-2 rounded-full whitespace-nowrap text-xs font-bold text-blue-500 flex items-center gap-1">‚õΩ 25K</button>
                    <button onclick="quickAdd('Parkir', 2000, 'out')" class="bg-gray-600/20 border border-gray-600/30 px-4 py-2 rounded-full whitespace-nowrap text-xs font-bold text-gray-400 flex items-center gap-1">üÖøÔ∏è 2K</button>
                </div>
            </div>

            <!-- Analytics Chart -->
            <div class="glass-card p-4 rounded-2xl relative overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-sm">Analisis Bulan Ini</h3>
                    <select id="month-filter" class="bg-transparent text-xs border border-gray-600 rounded px-2 py-1 outline-none" onchange="renderAnalytics()">
                        <option value="all">Semua</option>
                        <option value="this_month">Bulan Ini</option>
                    </select>
                </div>
                <div class="flex items-center gap-4">
                    <div class="w-24 h-24 relative flex-shrink-0">
                        <canvas id="expenseChart"></canvas>
                    </div>
                    <div class="flex-1 space-y-2" id="expense-legend">
                        <!-- Legend Injected Here -->
                    </div>
                </div>
            </div>

            <!-- Asset Summary Grid -->
            <div class="grid grid-cols-2 gap-3">
                <div class="glass-card p-3 rounded-2xl relative overflow-hidden" onclick="switchTab('cash')">
                    <div class="absolute right-0 bottom-0 opacity-10 text-5xl transform translate-x-2 translate-y-2"><i class="fa-solid fa-money-bill-wave"></i></div>
                    <p class="text-xs opacity-60">Cash Fisik</p>
                    <p class="font-bold text-lg amount-display" id="dash-cash">Rp 0</p>
                </div>
                <div class="glass-card p-3 rounded-2xl relative overflow-hidden" onclick="switchTab('assets')">
                    <div class="absolute right-0 bottom-0 opacity-10 text-5xl transform translate-x-2 translate-y-2"><i class="fa-solid fa-wallet"></i></div>
                    <p class="text-xs opacity-60">Dompet Digital</p>
                    <p class="font-bold text-lg amount-display" id="dash-wallet">Rp 0</p>
                </div>
                <div class="glass-card p-3 rounded-2xl relative overflow-hidden" onclick="switchTab('assets', 'invest')">
                    <div class="absolute right-0 bottom-0 opacity-10 text-5xl transform translate-x-2 translate-y-2"><i class="fa-solid fa-chart-line"></i></div>
                    <p class="text-xs opacity-60">Investasi</p>
                    <p class="font-bold text-lg amount-display" id="dash-invest">Rp 0</p>
                </div>
                <div class="glass-card p-3 rounded-2xl relative overflow-hidden" onclick="switchTab('social')">
                    <div class="absolute right-0 bottom-0 opacity-10 text-5xl transform translate-x-2 translate-y-2"><i class="fa-solid fa-handshake"></i></div>
                    <p class="text-xs opacity-60">Piutang</p>
                    <p class="font-bold text-lg amount-display" id="dash-receivable">Rp 0</p>
                </div>
            </div>

            <!-- TOTAL KONDANGAN (FITUR BALIK LAGI) -->
            <div class="glass-card p-3 rounded-2xl flex justify-between items-center mt-2" onclick="switchTab('social', 'gift')">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-pink-500/20 flex items-center justify-center text-pink-400">
                        <i class="fa-solid fa-envelope-open-text"></i>
                    </div>
                    <div>
                        <p class="text-xs opacity-60">Total Amplop Keluar</p>
                        <p class="font-bold text-lg amount-display text-pink-400" id="dash-gifts">Rp 0</p>
                    </div>
                </div>
                <i class="fa-solid fa-chevron-right text-xs opacity-60"></i>
            </div>

            <!-- Recent Transactions -->
            <div class="pb-6">
                <h3 class="text-xs font-bold opacity-50 mb-3 uppercase tracking-wider">Riwayat Transaksi</h3>
                <div id="dashboard-transactions" class="space-y-3"></div>
            </div>
        </div>

        <!-- OTHER VIEWS (Cash, Assets, Target, Social) -->
        <div id="view-cash" class="hidden space-y-4">
            <div class="glass-card p-5 rounded-3xl text-center bg-emerald-900/20 border-emerald-500/20">
                 <p class="text-xs text-emerald-300 uppercase tracking-widest mb-1">Total Fisik</p>
                 <h2 class="text-3xl font-bold text-emerald-400 amount-display" id="calc-total">Rp 0</h2>
            </div>
            <div id="money-inputs" class="space-y-2"></div>
        </div>

        <div id="view-assets" class="hidden space-y-4">
            <div class="flex bg-gray-800/50 p-1 rounded-xl">
                <button onclick="switchAssetTab('wallet')" id="seg-wallet" class="flex-1 py-2 text-xs font-bold rounded-lg text-center transition bg-white/10 text-white">Dompet</button>
                <button onclick="switchAssetTab('invest')" id="seg-invest" class="flex-1 py-2 text-xs font-bold rounded-lg text-center transition text-gray-400">Investasi</button>
            </div>
            <div id="asset-wallet-view" class="space-y-3">
                <div class="flex justify-between px-1"><span class="text-xs opacity-60">Liquid Assets</span><button onclick="openModal('wallet')" class="text-accent font-bold text-xs">+ Tambah</button></div>
                <div id="wallet-list" class="space-y-3"></div>
            </div>
            <div id="asset-invest-view" class="hidden space-y-3">
                <div class="flex justify-between px-1"><span class="text-xs opacity-60">Portfolio</span><button onclick="openModal('invest')" class="text-accent font-bold text-xs">+ Tambah</button></div>
                <div id="invest-list" class="space-y-3"></div>
            </div>
        </div>

        <div id="view-target" class="hidden space-y-4">
            <div class="glass-card p-4 rounded-2xl flex justify-between items-center">
                <div><h3 class="font-bold">Target Impian</h3><p class="text-xs opacity-60">Goals</p></div>
                <button onclick="openModal('target')" class="bg-white/10 px-4 py-2 rounded-lg text-sm font-semibold">+ Baru</button>
            </div>
            <div id="target-list" class="space-y-4 pb-10"></div>
        </div>

        <div id="view-social" class="hidden space-y-4">
            <div class="flex bg-gray-800/50 p-1 rounded-xl">
                <button onclick="switchSocialTab('debt')" id="seg-debt" class="flex-1 py-2 text-xs font-bold rounded-lg text-center bg-white/10 text-white">Hutang</button>
                <button onclick="switchSocialTab('gift')" id="seg-gift" class="flex-1 py-2 text-xs font-bold rounded-lg text-center text-gray-400">Kondangan</button>
            </div>
            <div id="social-debt-view" class="space-y-3">
                <div class="flex justify-between px-1"><span class="text-xs opacity-60">Catatan Pinjaman</span><button onclick="openModal('debt')" class="text-accent font-bold text-xs">+ Catat</button></div>
                <div id="debt-list" class="space-y-3"></div>
            </div>
            <div id="social-gift-view" class="hidden space-y-3">
                <div class="flex justify-between px-1"><span class="text-xs opacity-60">Amplop Keluar</span><button onclick="openModal('gift')" class="text-accent font-bold text-xs">+ Amplop</button></div>
                <div id="gift-list" class="space-y-3"></div>
            </div>
        </div>
    </main>

    <!-- DOCK -->
    <nav class="dock fixed bottom-0 left-0 right-0 px-2 pt-3 flex justify-around items-center z-50">
        <button onclick="switchTab('dashboard')" class="nav-item active flex flex-col items-center gap-1 w-1/5" id="nav-dashboard"><i class="fa-solid fa-house text-xl"></i><span class="text-[10px]">Home</span></button>
        <button onclick="switchTab('cash')" class="nav-item flex flex-col items-center gap-1 w-1/5" id="nav-cash"><i class="fa-solid fa-money-bill text-xl"></i><span class="text-[10px]">Cash</span></button>
        <button onclick="switchTab('assets')" class="nav-item flex flex-col items-center gap-1 w-1/5" id="nav-assets"><i class="fa-solid fa-wallet text-xl"></i><span class="text-[10px]">Aset</span></button>
        <button onclick="switchTab('target')" class="nav-item flex flex-col items-center gap-1 w-1/5" id="nav-target"><i class="fa-solid fa-bullseye text-xl"></i><span class="text-[10px]">Target</span></button>
        <button onclick="switchTab('social')" class="nav-item flex flex-col items-center gap-1 w-1/5" id="nav-social"><i class="fa-solid fa-user-group text-xl"></i><span class="text-[10px]">Sosial</span></button>
    </nav>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[70] flex items-end justify-center">
        <div class="glass-panel w-full sm:max-w-sm rounded-t-3xl p-6 transform transition-transform duration-300">
            <div class="w-12 h-1 bg-gray-500/50 rounded-full mx-auto mb-6"></div>
            <h3 class="text-xl font-bold mb-4">Pengaturan</h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center p-3 rounded-xl bg-white/5 border border-white/10">
                    <span class="text-sm">Tema Gelap (Dark Mode)</span>
                    <button onclick="toggleTheme()" class="w-12 h-6 rounded-full bg-indigo-600 relative transition" id="theme-toggle-btn">
                        <div class="w-4 h-4 bg-white rounded-full absolute top-1 right-1 transition transform" id="theme-toggle-circle"></div>
                    </button>
                </div>
                <button onclick="setupPin()" class="w-full py-3 rounded-xl bg-white/5 border border-white/10 flex items-center justify-between px-4 hover:bg-white/10">
                    <span class="text-sm"><i class="fa-solid fa-lock mr-2"></i> Ubah PIN (Default: 1234)</span>
                    <i class="fa-solid fa-chevron-right text-xs opacity-50"></i>
                </button>
                <button onclick="exportToExcel()" class="w-full py-3 rounded-xl bg-green-600 hover:bg-green-500 text-white font-bold flex items-center justify-center gap-2">
                    <i class="fa-solid fa-file-excel"></i> Export Excel (.csv)
                </button>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="exportData()" class="py-3 rounded-xl bg-blue-600 font-bold text-xs">Backup JSON</button>
                    <button onclick="document.getElementById('import-file').click()" class="py-3 rounded-xl bg-gray-700 font-bold text-xs">Restore JSON</button>
                    <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
                </div>
                <button onclick="closeSettings()" class="w-full py-3 text-gray-400 text-sm mt-2">Tutup</button>
            </div>
        </div>
    </div>

    <!-- UNIVERSAL FORM MODAL -->
    <div id="modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[60] flex items-end justify-center">
        <div class="glass-panel w-full sm:max-w-sm rounded-t-3xl p-6 animate-slide-up">
            <div class="w-12 h-1 bg-gray-500/50 rounded-full mx-auto mb-6"></div>
            <h3 class="text-xl font-bold mb-4" id="modal-title">Form</h3>
            <div class="space-y-4 max-h-[70vh] overflow-y-auto no-scrollbar">
                <div id="modal-fields" class="space-y-3"></div>
                <div class="flex gap-3 mt-4">
                    <button onclick="closeModal()" class="flex-1 py-3 rounded-xl bg-white/10">Batal</button>
                    <button onclick="saveModalData()" class="flex-1 py-3 rounded-xl bg-indigo-600 font-bold" id="btn-save-modal">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TRANSACTION MODAL -->
    <div id="trx-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[65] flex items-end justify-center">
        <div class="glass-panel w-full sm:max-w-sm rounded-t-3xl p-6">
            <h3 class="text-lg font-bold mb-4" id="trx-title">Transaksi</h3>
            <div class="space-y-4">
                <div><label class="text-xs opacity-60">Sumber Dana</label><select id="trx-source" class="glass-input p-3 rounded-xl mt-1 bg-black"></select></div>
                <div><label class="text-xs opacity-60">Keterangan</label><input type="text" id="trx-note" class="glass-input p-3 rounded-xl mt-1" placeholder="cth: Makan Siang"></div>
                <div class="flex gap-2 text-[10px] overflow-x-auto no-scrollbar" id="category-chips"></div>
                <div><label class="text-xs opacity-60">Nominal</label><input type="text" inputmode="numeric" id="trx-amount" class="glass-input p-3 rounded-xl mt-1 font-bold text-xl" oninput="formatInput(this)"></div>
                <div class="flex gap-3 mt-4">
                    <button onclick="closeTrxModal()" class="flex-1 py-3 rounded-xl bg-white/10">Batal</button>
                    <button onclick="saveTransaction()" class="flex-1 py-3 rounded-xl bg-indigo-600 font-bold" id="btn-save-trx">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TARGET ACTION MODAL -->
    <div id="target-action-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[65] flex items-end justify-center">
        <div class="glass-panel w-full sm:max-w-sm rounded-t-3xl p-6">
             <h3 class="text-lg font-bold mb-2" id="action-target-name">Target</h3>
             <input type="text" inputmode="numeric" id="action-amount" class="glass-input p-3 rounded-xl mb-4" placeholder="Jumlah Nabung" oninput="formatInput(this)">
             <div class="grid grid-cols-2 gap-3"><button onclick="deleteItem('targets', activeTargetId)" class="py-3 rounded-xl bg-red-500/20 text-red-400">Hapus</button><button onclick="saveTargetProgress()" class="py-3 rounded-xl bg-emerald-600 text-white font-bold">Nabung</button></div>
             <button onclick="document.getElementById('target-action-modal').classList.add('hidden')" class="w-full mt-3 py-2 text-gray-500 text-sm">Batal</button>
        </div>
    </div>

    <script>
        let appData = { 
            cash: {}, accounts: [], targets: [], debts: [], gifts: [], transactions: [],
            settings: { pin: '1234', theme: 'dark' }
        };
        let editingId = null; let activeTargetId = null; let trxType = 'out'; let modalMode = '';
        let privacyMode = false; let chartInstance = null; let pinBuffer = "";

        const denominations = [
            { val: 100000, label: '100K', color: 'text-red-400' }, { val: 50000, label: '50K', color: 'text-blue-400' },
            { val: 20000, label: '20K', color: 'text-emerald-400' }, { val: 10000, label: '10K', color: 'text-purple-400' },
            { val: 5000, label: '5K', color: 'text-yellow-400' }, { val: 2000, label: '2K', color: 'text-gray-400' },
            { val: 1000, label: '1K Kertas', color: 'text-emerald-400' }, { val: 1000, label: '1K Koin', color: 'text-yellow-400' },
            { val: 500, label: '500', color: 'text-gray-400' }, { val: 200, label: '200', color: 'text-gray-400' }, { val: 100, label: '100', color: 'text-gray-400' }
        ];

        function init() {
            const saved = localStorage.getItem('iFinanceUltra');
            if (saved) { 
                appData = JSON.parse(saved); 
                if(!appData.settings) appData.settings = { pin: '1234', theme: 'dark' };
            } else {
                const old = localStorage.getItem('iFinancePro');
                if(old) appData = { ...appData, ...JSON.parse(old) };
                if(!appData.settings) appData.settings = {};
                appData.settings.pin = '1234';
            }
            applyTheme(appData.settings.theme);
            if(appData.settings.pin) showLockScreen();
            else renderAll();
        }

        function showLockScreen() { document.getElementById('lock-screen').classList.remove('hidden'); }
        function enterPin(n) {
            pinBuffer += n; updatePinDots();
            if(pinBuffer.length === 4) {
                if(pinBuffer === appData.settings.pin) {
                    document.getElementById('lock-screen').classList.add('hidden');
                    pinBuffer = ""; updatePinDots(); renderAll();
                } else { alert("PIN Salah!"); pinBuffer = ""; updatePinDots(); }
            }
        }
        function clearPin() { pinBuffer = pinBuffer.slice(0, -1); updatePinDots(); }
        function updatePinDots() { for(let i=1; i<=4; i++) document.getElementById(`dot-${i}`).className = `pin-dot ${i <= pinBuffer.length ? 'filled' : ''}`; }
        function setupPin() {
            const newPin = prompt("Buat 4 digit PIN baru:");
            if(newPin && newPin.length === 4 && !isNaN(newPin)) {
                appData.settings.pin = newPin; saveData(); alert("PIN Berhasil Diubah!");
            } else alert("PIN harus 4 angka!");
        }
        function emergencyReset() {
            if(confirm("LUPA PIN? Reset semua data aplikasi?")) { localStorage.clear(); location.reload(); }
        }

        function saveData() { localStorage.setItem('iFinanceUltra', JSON.stringify(appData)); updateSummary(); renderAnalytics(); }
        function renderAll() { renderCalculator(); renderAssets(); renderTargets(); renderDebts(); renderGifts(); renderTrx(); updateSummary(); renderAnalytics(); }

        function detectCategory(note) {
            const n = note.toLowerCase();
            if(n.match(/kopi|makan|minum|gojek food|grab food|cafe|warteg/)) return 'F&B';
            if(n.match(/bensin|parkir|tol|grab|gojek|uber|transport|service/)) return 'Transport';
            if(n.match(/listrik|air|wifi|pulsa|paket data|netflix|spotify|kos/)) return 'Bills';
            if(n.match(/belanja|indomaret|alfamart|supermarket|baju|sepatu/)) return 'Shopping';
            if(n.match(/gaji|bonus|thr|invoice/)) return 'Income';
            return 'Lainnya';
        }

        function renderAnalytics() {
            const ctx = document.getElementById('expenseChart'); if(!ctx) return;
            const filter = document.getElementById('month-filter').value;
            const now = new Date();
            let filteredTrx = appData.transactions.filter(t => t.type === 'out');
            if(filter === 'this_month') filteredTrx = filteredTrx.filter(t => new Date(t.date).getMonth() === now.getMonth());

            const categories = {}; let total = 0;
            filteredTrx.forEach(t => {
                const cat = detectCategory(t.note); categories[cat] = (categories[cat] || 0) + t.amount; total += t.amount;
            });

            const labels = Object.keys(categories); const data = Object.values(categories);
            const legend = document.getElementById('expense-legend'); legend.innerHTML = '';
            labels.forEach((l, i) => {
                const pct = Math.round((data[i] / total) * 100) || 0;
                legend.innerHTML += `<div class="flex justify-between text-xs"><span class="font-bold">${l}</span><span>${pct}% (${formatRupiah(data[i])})</span></div>`;
            });

            if(chartInstance) { chartInstance.data.labels = labels; chartInstance.data.datasets[0].data = data; chartInstance.update(); } 
            else {
                chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels, datasets: [{ data, backgroundColor: ['#f59e0b', '#3b82f6', '#ef4444', '#10b981', '#8b5cf6'], borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }
        }

        function exportToExcel() {
            let csv = "Tanggal,Tipe,Kategori,Keterangan,Akun,Nominal\n";
            appData.transactions.forEach(t => {
                csv += `${new Date(t.date).toLocaleDateString('id-ID')},${t.type},${detectCategory(t.note)},"${t.note}",${t.sourceLabel},${t.amount}\n`;
            });
            const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            link.download = "Laporan_Keuangan.csv"; link.click();
        }

        function quickAdd(note, amount, type) {
            openTransactionModal(type); document.getElementById('trx-note').value = note; document.getElementById('trx-amount').value = new Intl.NumberFormat('id-ID').format(amount);
        }

        function renderCalculator() {
            const c=document.getElementById('money-inputs'); c.innerHTML='';
            denominations.forEach(d=>{
                const k=`${d.val}-${d.type}`; const count=appData.cash[k]||0;
                c.innerHTML+=`<div class="glass-card p-3 rounded-xl flex items-center justify-between gap-3"><div class="flex flex-col flex-1 min-w-0"><span class="font-bold ${d.color} text-lg truncate">${d.label}</span></div><div class="flex items-center gap-1 bg-black/30 rounded-lg p-1"><button onclick="updateCash('${k}',-1)" class="w-10 h-10 rounded-lg bg-white/10 active:bg-white/20 font-bold">-</button><input type="number" value="${count||''}" placeholder="0" class="w-16 bg-transparent text-center font-bold text-white focus:outline-none text-lg" onchange="setCash('${k}',this.value)"><button onclick="updateCash('${k}',1)" class="w-10 h-10 rounded-lg bg-white/10 active:bg-white/20 font-bold">+</button></div></div>`;
            });
            calcCashTotal();
        }

        function renderAssets() {
            const w=document.getElementById('wallet-list'); const i=document.getElementById('invest-list'); w.innerHTML=''; i.innerHTML='';
            appData.accounts.forEach(a => {
                const inv = ['stock','crypto','gold','invest'].includes(a.type);
                let roiHtml = '';
                if(inv && a.buyPrice && a.balance) {
                    const profit = a.balance - a.buyPrice; const pct = ((profit / a.buyPrice) * 100).toFixed(1);
                    roiHtml = `<div class="text-[10px] ${profit>=0?'text-emerald-400':'text-rose-400'}">${profit>=0?'+':''}${formatRupiah(profit)} (${pct}%)</div>`;
                }
                const html = `<div class="glass-card p-4 rounded-xl flex justify-between items-center group relative"><div class="flex items-center gap-3">${getIcon(a.type, a.name)}<div><p class="font-bold">${a.name}</p><p class="text-xs opacity-60 capitalize">${translateType(a.type)}</p></div></div><div class="text-right"><p class="font-bold amount-display">${formatRupiah(a.balance)}</p>${roiHtml}<div class="flex justify-end gap-3 mt-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="openModal('${inv?'invest':'wallet'}', ${a.id})" class="text-xs text-blue-400">Edit</button><button onclick="deleteItem('accounts', ${a.id})" class="text-xs text-red-400">Hapus</button></div></div></div>`;
                if(inv) i.innerHTML+=html; else w.innerHTML+=html;
            });
        }

        function renderTargets() {
            const l = document.getElementById('target-list'); l.innerHTML = '';
            if (appData.targets.length === 0) { l.innerHTML = '<p class="text-center opacity-50 text-xs mt-10">Mulai buat impian pertamamu!</p>'; return; }
            appData.targets.forEach(t => {
                const pct = Math.min(100, Math.round((t.current / t.goal) * 100));
                l.innerHTML += `<div class="glass-card p-4 rounded-xl cursor-pointer" onclick="openTargetAction(${t.id})"><div class="flex justify-between items-end mb-2"><h4 class="font-bold truncate pr-4">${t.name}</h4><span class="text-xs text-blue-400 font-bold">${pct}%</span></div><div class="w-full bg-gray-700/50 h-2 rounded-full overflow-hidden mb-2"><div class="h-full bg-blue-500" style="width:${pct}%"></div></div><div class="flex justify-between text-[10px] opacity-60"><span class="amount-display">${formatRupiah(t.current)}</span><span class="amount-display">Target: ${formatRupiah(t.goal)}</span></div></div>`;
            });
        }

        function renderDebts() {
            const l = document.getElementById('debt-list'); l.innerHTML = '';
            appData.debts.forEach(d => {
                const lent = d.type === 'lent';
                l.innerHTML += `<div class="glass-card p-4 rounded-xl flex justify-between relative overflow-hidden"><div class="absolute left-0 top-0 bottom-0 w-1 ${lent?'bg-emerald-500':'bg-red-500'}"></div><div class="pl-2"><div><span class="font-bold">${d.name}</span> <span class="text-[10px] px-2 py-0.5 rounded ${lent?'bg-emerald-500/20 text-emerald-400':'bg-red-500/20 text-red-400'}">${lent?'Dipinjam':'Hutang'}</span></div><p class="text-xs opacity-60 mt-1">${new Date(d.date).toLocaleDateString('id-ID',{day:'numeric',month:'short'})}</p></div><div class="text-right"><p class="font-bold amount-display">${formatRupiah(d.amount)}</p><button onclick="deleteItem('debts', ${d.id})" class="text-xs text-red-400 mt-1">Lunas</button></div></div>`;
            });
        }

        function renderGifts() {
            const l = document.getElementById('gift-list'); l.innerHTML = '';
            appData.gifts.forEach(g => {
                l.innerHTML += `<div class="glass-card p-4 rounded-xl flex justify-between"><div><p class="font-bold">${g.name}</p><p class="text-xs opacity-60">${new Date(g.date).toLocaleDateString('id-ID',{day:'numeric',month:'short'})}</p></div><div class="text-right"><p class="font-bold text-pink-400 amount-display">${formatRupiah(g.amount)}</p><button onclick="deleteItem('gifts', ${g.id})" class="text-xs text-red-400">Hapus</button></div></div>`;
            });
        }

        function openTransactionModal(t) {
            trxType = t; document.getElementById('trx-modal').classList.remove('hidden');
            document.getElementById('trx-title').innerText = t==='in'?"Pemasukan":"Pengeluaran";
            document.getElementById('btn-save-trx').className = `flex-1 py-3 rounded-xl text-white font-bold ${t==='in'?'bg-emerald-600':'bg-rose-600'}`;
            const s=document.getElementById('trx-source'); s.innerHTML='<option value="cash">Cash (Uang Fisik)</option>';
            appData.accounts.forEach(a=>s.innerHTML+=`<option value="${a.id}">${a.name}</option>`);
            document.getElementById('trx-amount').value=''; document.getElementById('trx-note').value='';
        }
        
        function saveTransaction() {
            const amt = getRawValue('trx-amount'); const note = document.getElementById('trx-note').value; const src = document.getElementById('trx-source').value;
            if(amt <= 0) return;
            let lbl = 'Cash';
            if(src !== 'cash') {
                const acc = appData.accounts.find(a => a.id == src);
                if(acc) { lbl = acc.name; if(trxType === 'out') acc.balance -= amt; else acc.balance += amt; }
            }
            appData.transactions.unshift({ id: Date.now(), date: new Date().toISOString(), type: trxType, amount: amt, note: note || (trxType==='in'?'Pemasukan':'Pengeluaran'), sourceId: src, sourceLabel: lbl });
            saveData(); renderAll(); document.getElementById('trx-modal').classList.add('hidden');
        }

        function renderTrx() {
            const c=document.getElementById('dashboard-transactions'); c.innerHTML='';
            const filter = document.getElementById('month-filter').value;
            const now = new Date();
            let data = appData.transactions;
            if(filter === 'this_month') data = data.filter(t => new Date(t.date).getMonth() === now.getMonth());
            
            data.slice(0, 5).forEach(t => {
                const cat = detectCategory(t.note);
                c.innerHTML += `<div class="flex justify-between items-center py-2 border-b border-white/5 last:border-0"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-xs">${getCatIcon(cat)}</div><div><p class="text-sm font-bold">${t.note}</p><p class="text-[10px] opacity-60">${t.sourceLabel} ‚Ä¢ ${cat}</p></div></div><p class="text-sm font-bold ${t.type==='out'?'text-rose-400':'text-emerald-400'} amount-display">${t.type==='out'?'-':'+'} ${formatRupiah(t.amount)}</p></div>`;
            });
        }

        function openModal(mode, editId = null) {
            modalMode = mode; editingId = editId; document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal-fields').innerHTML = '';
            let ex = editId ? getExistingData(mode, editId) : null;
            document.getElementById('modal-title').innerText = getModalTitle(mode, !!editId);

            const addInput = (label, id, type='text', val='') => document.getElementById('modal-fields').innerHTML += `<div><label class="text-xs opacity-60 uppercase">${label}</label><input type="${type}" id="${id}" class="glass-input p-3 rounded-xl mt-1" value="${val}"></div>`;
            const addMoney = (label, id, val='') => document.getElementById('modal-fields').innerHTML += `<div><label class="text-xs opacity-60 uppercase">${label}</label><input type="text" inputmode="numeric" id="${id}" class="glass-input p-3 rounded-xl mt-1 font-bold text-lg" value="${val?formatRupiah(val).replace('Rp ',''):''}" oninput="formatInput(this)"></div>`;

            addInput('Nama', 'modal-name', 'text', ex?.name || '');

            if(mode === 'wallet') {
                document.getElementById('modal-fields').innerHTML += `<div><label class="text-xs opacity-60 uppercase">Tipe</label><select id="modal-provider" class="glass-input p-3 rounded-xl mt-1 bg-black"><option value="wallet">E-Wallet</option><option value="bank">Bank</option></select></div>`;
                addMoney('Saldo Saat Ini', 'modal-amount', ex?.balance);
            }
            if(mode === 'invest') {
                document.getElementById('modal-fields').innerHTML += `<div><label class="text-xs opacity-60 uppercase">Jenis</label><select id="modal-provider" class="glass-input p-3 rounded-xl mt-1 bg-black"><option value="stock">Saham</option><option value="crypto">Crypto</option><option value="gold">Emas</option></select></div>`;
                addMoney('Nilai Sekarang (Balance)', 'modal-amount', ex?.balance);
                addMoney('Modal Awal (Buy Price) - Opsional', 'modal-buy', ex?.buyPrice);
            }
            if(mode === 'debt') {
                addMoney('Nominal', 'modal-amount', ex?.amount);
                document.getElementById('modal-fields').innerHTML += `<div class="grid grid-cols-2 gap-2 mt-2"><button id="btn-lent" onclick="setDebtType('lent')" class="p-3 rounded-xl border border-gray-600">Dipinjam</button><button id="btn-borrowed" onclick="setDebtType('borrowed')" class="p-3 rounded-xl border border-gray-600">Hutang</button></div>`;
                setTimeout(() => setDebtType(ex?.type || 'lent'), 10);
            }
            if(mode === 'target') {
                addMoney('Target Nominal', 'modal-goal', ex?.goal);
                if(!editId) addMoney('Saldo Awal (Opsional)', 'modal-amount', 0);
            }
            if(mode === 'gift') {
                addMoney('Nominal Amplop', 'modal-amount', ex?.amount);
                document.getElementById('modal-fields').innerHTML += `<div><label class="text-xs opacity-60 uppercase">Tanggal</label><input type="date" id="modal-date" class="glass-input p-3 rounded-xl mt-1" style="color-scheme:dark"></div>`;
            }
        }

        function saveModalData() {
            const name = document.getElementById('modal-name').value;
            let amt = 0; if(document.getElementById('modal-amount')) amt = getRawValue('modal-amount');
            const buy = document.getElementById('modal-buy') ? getRawValue('modal-buy') : 0;
            const id = editingId || Date.now();
            
            if(modalMode === 'invest' || modalMode === 'wallet') {
                const type = document.getElementById('modal-provider').value;
                const newItem = { id, name, type, balance: amt, buyPrice: buy };
                if(editingId) appData.accounts[appData.accounts.findIndex(x=>x.id==editingId)] = newItem;
                else appData.accounts.push(newItem);
            }
            else if(modalMode === 'debt') {
                const newItem = { id, name, type: currentDebtType, amount: amt, date: new Date().toISOString() };
                if(editingId) appData.debts[appData.debts.findIndex(x=>x.id==editingId)] = newItem;
                else appData.debts.unshift(newItem);
            }
            else if(modalMode === 'target') {
                const goal = getRawValue('modal-goal');
                let current = amt;
                if(editingId) {
                    const existing = appData.targets.find(x=>x.id==editingId);
                    current = existing.current; 
                    appData.targets[appData.targets.findIndex(x=>x.id==editingId)] = { id, name, current, goal };
                } else appData.targets.push({ id, name, current, goal });
            }
            else if(modalMode === 'gift') {
                const date = document.getElementById('modal-date').value || new Date().toISOString();
                const newItem = { id, name, amount: amt, date };
                if(editingId) appData.gifts[appData.gifts.findIndex(x=>x.id==editingId)] = newItem;
                else appData.gifts.unshift(newItem);
            }
            saveData(); closeModal(); renderAll();
        }

        function openTargetAction(id) { activeTargetId = id; document.getElementById('target-action-modal').classList.remove('hidden'); document.getElementById('action-amount').value = ''; const t = appData.targets.find(x => x.id == id); if(t) document.getElementById('action-target-name').innerText = t.name; }
        function saveTargetProgress() { const amt = getRawValue('action-amount'); const t = appData.targets.find(x => x.id == activeTargetId); if (t) { t.current += amt; saveData(); renderAll(); document.getElementById('target-action-modal').classList.add('hidden'); } }

        let currentDebtType = 'lent';
        function setDebtType(t) {
            currentDebtType = t;
            document.getElementById('btn-lent').className = t==='lent' ? "p-3 rounded-xl border border-emerald-500 bg-emerald-500/20 text-emerald-400 font-bold" : "p-3 rounded-xl border border-gray-600 opacity-50";
            document.getElementById('btn-borrowed').className = t==='borrowed' ? "p-3 rounded-xl border border-rose-500 bg-rose-500/20 text-rose-400 font-bold" : "p-3 rounded-xl border border-gray-600 opacity-50";
        }
        function getExistingData(mode, id) {
            if(mode.includes('wallet') || mode.includes('invest')) return appData.accounts.find(x=>x.id==id);
            if(mode === 'debt') return appData.debts.find(x=>x.id==id);
            if(mode === 'target') return appData.targets.find(x=>x.id==id);
            if(mode === 'gift') return appData.gifts.find(x=>x.id==id);
            return null;
        }
        function getModalTitle(m, edit) {
            if(m==='invest') return edit ? "Edit Investasi" : "Tambah Investasi";
            if(m==='wallet') return edit ? "Edit Dompet" : "Tambah Dompet";
            if(m==='target') return edit ? "Edit Target" : "Tambah Target";
            return "Form";
        }
        
        function formatInput(el) { let v = el.value.replace(/\D/g,''); el.value = v ? new Intl.NumberFormat('id-ID').format(v) : ''; }
        function getRawValue(id) { const el=document.getElementById(id); return el ? parseInt(el.value.replace(/\./g,''))||0 : 0; }
        function formatRupiah(n) { return new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(n); }
        function toggleTheme() { appData.settings.theme = appData.settings.theme === 'dark' ? 'light' : 'dark'; applyTheme(appData.settings.theme); saveData(); }
        function applyTheme(t) { document.body.setAttribute('data-theme', t); const btn = document.getElementById('theme-toggle-circle'); if(btn) btn.style.transform = t==='dark' ? 'translateX(0)' : 'translateX(24px)'; }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        function closeTrxModal() { document.getElementById('trx-modal').classList.add('hidden'); }
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        
        function getCatIcon(cat) { const map = { 'F&B':'üçî', 'Transport':'‚õΩ', 'Bills':'‚ö°', 'Shopping':'üõçÔ∏è', 'Income':'üí∞', 'Lainnya':'üìù' }; return map[cat] || 'üìù'; }
        function getIcon(type, name) {
            const n = name.toLowerCase();
            const logos = { 'gopay': 'https://upload.wikimedia.org/wikipedia/commons/8/86/Gopay_logo.svg', 'bca': 'https://upload.wikimedia.org/wikipedia/commons/5/5c/Bank_Central_Asia.svg', 'bri': 'https://upload.wikimedia.org/wikipedia/commons/6/68/BANK_BRI_logo.svg', 'mandiri': 'https://upload.wikimedia.org/wikipedia/commons/a/ad/Bank_Mandiri_logo_2016.svg', 'shopee': 'https://upload.wikimedia.org/wikipedia/commons/f/fe/Shopee.svg', 'dana': 'https://upload.wikimedia.org/wikipedia/commons/7/72/Logo_dana_blue.svg', 'jago': 'https://upload.wikimedia.org/wikipedia/commons/d/d1/Bank_Jago_logo.svg', 'seabank': 'https://upload.wikimedia.org/wikipedia/commons/0/0e/SeaBank_logo.svg' };
            for(let k in logos) if(n.includes(k)) return `<img src="${logos[k]}" class="w-8 h-8 rounded-full bg-white p-1">`;
            return `<div class="w-8 h-8 rounded-full bg-gray-500/20 flex items-center justify-center">üí≥</div>`;
        }
        function translateType(t) { return t; }
        
        function updateCash(k,d) { const c=appData.cash[k]||0; appData.cash[k]=Math.max(0,c+d); renderCalculator(); saveData(); }
        function setCash(k,v) { appData.cash[k]=parseInt(v)||0; renderCalculator(); saveData(); }
        function calcCashTotal() { let t=0; denominations.forEach(d=>t+=(appData.cash[`${d.val}-${d.type}`]||0)*d.val); document.getElementById('calc-total').innerText=formatRupiah(t); document.getElementById('dash-cash').innerText=formatRupiah(t); return t; }
        function deleteItem(arr, id) { if(confirm("Hapus?")) { appData[arr]=appData[arr].filter(x=>x.id!=id); saveData(); renderAll(); } }
        function updateSummary() {
            const cash = calcCashTotal();
            
            const wallet = appData.accounts.filter(a => !['stock','crypto','gold','invest'].includes(a.type)).reduce((a,c)=>a+c.balance,0);
            const invest = appData.accounts.filter(a => ['stock','crypto','gold','invest'].includes(a.type)).reduce((a,c)=>a+c.balance,0);
            
            const lent = appData.debts.filter(d=>d.type==='lent').reduce((a,c)=>a+c.amount,0);
            const gifts = appData.gifts.reduce((a,c)=>a+c.amount,0);

            document.getElementById('header-net-worth').innerText = formatRupiah(cash+wallet+invest+lent);
            
            if(document.getElementById('dash-wallet')) document.getElementById('dash-wallet').innerText = formatRupiah(wallet);
            if(document.getElementById('dash-invest')) document.getElementById('dash-invest').innerText = formatRupiah(invest);
            if(document.getElementById('dash-receivable')) document.getElementById('dash-receivable').innerText = formatRupiah(lent);
            if(document.getElementById('dash-gifts')) document.getElementById('dash-gifts').innerText = formatRupiah(gifts);
            
            if(privacyMode) { document.querySelectorAll('.amount-display').forEach(el => el.classList.add('blur-amount')); }
        }
        function switchTab(v,s) { 
            ['dashboard','cash','assets','target','social'].forEach(id=>document.getElementById(`view-${id}`).classList.add('hidden'));
            document.getElementById(`view-${v}`).classList.remove('hidden');
            if(v==='assets' && s) switchAssetTab(s);
        }
        function switchAssetTab(t) {
            document.getElementById('asset-wallet-view').classList.add('hidden'); document.getElementById('asset-invest-view').classList.add('hidden');
            document.getElementById('seg-wallet').className="flex-1 py-2 text-xs font-bold rounded-lg text-center transition text-gray-400";
            document.getElementById('seg-invest').className="flex-1 py-2 text-xs font-bold rounded-lg text-center transition text-gray-400";
            document.getElementById(`asset-${t}-view`).classList.remove('hidden');
            document.getElementById(`seg-${t}`).className="flex-1 py-2 text-xs font-bold rounded-lg text-center transition bg-white/10 text-white";
        }
        function switchSocialTab(t) {
            document.getElementById('social-debt-view').classList.add('hidden'); document.getElementById('social-gift-view').classList.add('hidden');
            document.getElementById('seg-debt').className="flex-1 py-2 text-xs font-bold rounded-lg text-center transition text-gray-400";
            document.getElementById('seg-gift').className="flex-1 py-2 text-xs font-bold rounded-lg text-center transition text-gray-400";
            document.getElementById(`social-${t}-view`).classList.remove('hidden');
            document.getElementById(`seg-${t}`).className="flex-1 py-2 text-xs font-bold rounded-lg text-center transition bg-white/10 text-white";
        }
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            const dlNode = document.createElement('a');
            dlNode.setAttribute("href", dataStr);
            dlNode.setAttribute("download", "ifinance_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(dlNode); dlNode.click(); dlNode.remove();
        }
        function importData(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try { const dat = JSON.parse(e.target.result); if(dat.cash && dat.accounts) { if(confirm("Restore data?")) { appData = dat; saveData(); renderAll(); alert("Sukses!"); closeSettings(); } } else alert("File salah!"); } catch(e) { alert("File rusak!"); }
            }; reader.readAsText(file); input.value = '';
        }
        
        init();
    </script>
</body>
</html>
