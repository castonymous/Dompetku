<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iFinance Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&family=Inter:wght@400;600&display=swap');

        /* --- THEME CONFIG --- */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #000;
            color: white;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 120px; /* Space for dock */
        }

        /* Fluid Background */
        .ambient-light {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1;
            background: 
                radial-gradient(circle at 10% 20%, rgba(68, 55, 255, 0.4) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255, 48, 100, 0.3) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(48, 207, 255, 0.2) 0%, transparent 60%);
            filter: blur(60px);
            animation: pulse 10s infinite alternate;
        }
        @keyframes pulse { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }

        /* Glass UI */
        .glass-panel {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }
        .glass-card:active { transform: scale(0.98); background: rgba(255, 255, 255, 0.1); }
        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            width: 100%;
        }
        .glass-input:focus { outline: none; border-color: rgba(255, 255, 255, 0.3); background: rgba(0, 0, 0, 0.5); }

        /* Sub-tab Switcher */
        .segment-control {
            background: rgba(0,0,0,0.3);
            padding: 4px;
            border-radius: 12px;
            display: flex;
            margin-bottom: 15px;
        }
        .segment-btn {
            flex: 1;
            text-align: center;
            padding: 8px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 8px;
            color: #9ca3af;
            transition: all 0.3s;
        }
        .segment-btn.active {
            background: rgba(255,255,255,0.15);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Bottom Dock */
        .dock {
            background: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
        .nav-item { transition: all 0.3s; opacity: 0.5; }
        .nav-item.active { opacity: 1; transform: translateY(-2px); }
        .nav-item.active i { color: #60a5fa; text-shadow: 0 0 10px rgba(96, 165, 250, 0.6); }
        
        /* Utils */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

    <div class="ambient-light"></div>

    <!-- Header -->
    <header class="sticky top-0 z-40 pt-4 pb-2 px-5 glass-panel border-t-0 border-x-0 rounded-b-3xl mb-4">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/30">
                    <i class="fa-brands fa-apple text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg tracking-tight">iFinance</h1>
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest">Ultimate Edition</p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-gray-400 text-xs mb-1">Total Net Worth</p>
                <h2 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-300 to-purple-300" id="header-net-worth">Rp 0</h2>
            </div>
        </div>
    </header>

    <main class="px-5 min-h-screen">

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="space-y-4 animate-fade-in">
            <!-- Summary Grid -->
            <div class="grid grid-cols-2 gap-3">
                <div class="glass-card p-4 rounded-2xl flex flex-col justify-between h-28 relative overflow-hidden group" onclick="switchTab('cash')">
                    <div class="absolute -right-4 -bottom-4 w-16 h-16 bg-emerald-500/20 rounded-full blur-xl"></div>
                    <i class="fa-solid fa-money-bill-wave text-emerald-400 text-2xl mb-2"></i>
                    <div><p class="text-xs text-gray-400">Cash Fisik</p><p class="font-bold text-lg" id="dash-cash">Rp 0</p></div>
                </div>
                
                <div class="glass-card p-4 rounded-2xl flex flex-col justify-between h-28 relative overflow-hidden group" onclick="switchTab('assets')">
                    <div class="absolute -right-4 -bottom-4 w-16 h-16 bg-blue-500/20 rounded-full blur-xl"></div>
                    <i class="fa-solid fa-wallet text-blue-400 text-2xl mb-2"></i>
                    <div><p class="text-xs text-gray-400">Dompet & Bank</p><p class="font-bold text-lg" id="dash-wallet">Rp 0</p></div>
                </div>

                <div class="glass-card p-4 rounded-2xl flex flex-col justify-between h-28 relative overflow-hidden group" onclick="switchTab('assets', 'invest')">
                    <div class="absolute -right-4 -bottom-4 w-16 h-16 bg-purple-500/20 rounded-full blur-xl"></div>
                    <i class="fa-solid fa-chart-line text-purple-400 text-2xl mb-2"></i>
                    <div><p class="text-xs text-gray-400">Investasi</p><p class="font-bold text-lg" id="dash-invest">Rp 0</p></div>
                </div>

                <div class="glass-card p-4 rounded-2xl flex flex-col justify-between h-28 relative overflow-hidden group" onclick="switchTab('social')">
                    <div class="absolute -right-4 -bottom-4 w-16 h-16 bg-orange-500/20 rounded-full blur-xl"></div>
                    <i class="fa-solid fa-hand-holding-dollar text-orange-400 text-2xl mb-2"></i>
                    <div><p class="text-xs text-gray-400">Piutang</p><p class="font-bold text-lg" id="dash-receivable">Rp 0</p></div>
                </div>
            </div>

            <!-- Top Target Teaser -->
            <div class="glass-card p-4 rounded-2xl mt-4" onclick="switchTab('target')">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-gray-200"><i class="fa-solid fa-bullseye text-red-400 mr-2"></i>Fokus Target</h3>
                    <i class="fa-solid fa-chevron-right text-xs text-gray-500"></i>
                </div>
                <div id="dash-target-content">
                    <p class="text-xs text-gray-500">Belum ada target impian.</p>
                </div>
            </div>
        </div>

        <!-- VIEW: CASH -->
        <div id="view-cash" class="hidden space-y-5">
            <div class="glass-panel p-5 rounded-3xl text-center relative overflow-hidden">
                 <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 to-green-300"></div>
                 <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Total Fisik</p>
                 <h2 class="text-3xl font-bold text-emerald-300" id="calc-total">Rp 0</h2>
            </div>
            <div class="space-y-3" id="money-inputs"></div>
        </div>

        <!-- VIEW: ASSETS (Wallet & Invest) -->
        <div id="view-assets" class="hidden space-y-5">
            <div class="segment-control">
                <button onclick="switchAssetTab('wallet')" id="seg-wallet" class="segment-btn active">Dompet / Bank</button>
                <button onclick="switchAssetTab('invest')" id="seg-invest" class="segment-btn">Investasi</button>
            </div>

            <!-- Tab: Wallet -->
            <div id="asset-wallet-view" class="space-y-4">
                <div class="flex justify-between items-center px-1">
                    <p class="text-xs text-gray-400">Saldo cair (Liquid)</p>
                    <button onclick="openModal('wallet')" class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white hover:scale-110 transition"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div id="wallet-list" class="space-y-3"></div>
            </div>

            <!-- Tab: Invest -->
            <div id="asset-invest-view" class="hidden space-y-4">
                <div class="flex justify-between items-center px-1">
                    <p class="text-xs text-gray-400">Aset berkembang</p>
                    <button onclick="openModal('invest')" class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center text-white hover:scale-110 transition"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div id="invest-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- VIEW: TARGETS -->
        <div id="view-target" class="hidden space-y-5">
            <div class="glass-panel p-4 rounded-2xl flex justify-between items-center">
                <div>
                    <h3 class="font-bold">Target Impian</h3>
                    <p class="text-xs text-gray-400">Tabung demi masa depan</p>
                </div>
                <button onclick="openModal('target')" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg text-sm font-semibold transition">+ Target</button>
            </div>
            
            <div id="target-list" class="space-y-4 pb-10"></div>
        </div>

        <!-- VIEW: SOCIAL -->
        <div id="view-social" class="hidden space-y-5">
            <div class="segment-control">
                <button onclick="switchSocialTab('debt')" id="seg-debt" class="segment-btn active">Hutang / Piutang</button>
                <button onclick="switchSocialTab('gift')" id="seg-gift" class="segment-btn">Kondangan</button>
            </div>

            <!-- Tab: Debt -->
            <div id="social-debt-view" class="space-y-4">
                <div class="flex justify-between items-center px-1">
                    <p class="text-xs text-gray-400">Manajemen pinjaman</p>
                    <button onclick="openModal('debt')" class="bg-white/10 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-white/20 transition">+ Catat</button>
                </div>
                <div id="debt-list" class="space-y-3"></div>
            </div>

            <!-- Tab: Gift -->
            <div id="social-gift-view" class="hidden space-y-4">
                <div class="flex justify-between items-center px-1">
                    <p class="text-xs text-gray-400">Riwayat amplop keluar</p>
                    <button onclick="openModal('gift')" class="bg-purple-500/20 text-purple-300 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-purple-500/30 transition">+ Amplop</button>
                </div>
                <div id="gift-list" class="space-y-3"></div>
            </div>
        </div>

    </main>

    <!-- DOCK NAVIGATION (5 ITEMS) -->
    <nav class="dock fixed bottom-0 left-0 right-0 px-2 pt-3 flex justify-around items-center z-50 rounded-t-3xl">
        <button onclick="switchTab('dashboard')" class="nav-item active flex flex-col items-center gap-1 w-1/5 text-gray-500" id="nav-dashboard">
            <i class="fa-solid fa-house text-xl"></i><span class="text-[10px] font-medium">Home</span>
        </button>
        <button onclick="switchTab('cash')" class="nav-item flex flex-col items-center gap-1 w-1/5 text-gray-500" id="nav-cash">
            <i class="fa-solid fa-money-bill text-xl"></i><span class="text-[10px] font-medium">Cash</span>
        </button>
        <button onclick="switchTab('assets')" class="nav-item flex flex-col items-center gap-1 w-1/5 text-gray-500" id="nav-assets">
            <i class="fa-solid fa-wallet text-xl"></i><span class="text-[10px] font-medium">Aset</span>
        </button>
        <button onclick="switchTab('target')" class="nav-item flex flex-col items-center gap-1 w-1/5 text-gray-500" id="nav-target">
            <i class="fa-solid fa-bullseye text-xl"></i><span class="text-[10px] font-medium">Target</span>
        </button>
        <button onclick="switchTab('social')" class="nav-item flex flex-col items-center gap-1 w-1/5 text-gray-500" id="nav-social">
            <i class="fa-solid fa-users text-xl"></i><span class="text-[10px] font-medium">Sosial</span>
        </button>
    </nav>

    <!-- UNIVERSAL MODAL -->
    <div id="modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[60] flex items-end sm:items-center justify-center">
        <div class="glass-panel w-full sm:max-w-sm rounded-t-3xl sm:rounded-3xl p-6 transform transition-transform duration-300">
            <div class="w-12 h-1 bg-gray-600 rounded-full mx-auto mb-6"></div>
            <h3 class="text-xl font-bold mb-4" id="modal-title">Form</h3>
            
            <div class="space-y-3 max-h-[70vh] overflow-y-auto no-scrollbar">
                
                <!-- Field: Debt Type -->
                <div id="field-debt-type" class="hidden mb-4">
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="debtType" value="lent" class="peer sr-only" checked>
                            <div class="glass-input p-3 rounded-xl text-center peer-checked:bg-emerald-600/50 peer-checked:border-emerald-500 border border-transparent">
                                <span class="text-xs font-bold block">Dipinjam</span><span class="text-[10px] opacity-70">(Aset Saya)</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="debtType" value="borrowed" class="peer sr-only">
                            <div class="glass-input p-3 rounded-xl text-center peer-checked:bg-red-600/50 peer-checked:border-red-500 border border-transparent">
                                <span class="text-xs font-bold block">Saya Hutang</span><span class="text-[10px] opacity-70">(Kewajiban)</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Field: Name -->
                <div>
                    <label class="text-xs text-gray-400 uppercase" id="label-name">Nama</label>
                    <input type="text" id="modal-name" class="glass-input p-3 rounded-xl mt-1" placeholder="Isi nama...">
                </div>

                <!-- Field: Provider Type -->
                <div id="field-provider" class="hidden">
                    <label class="text-xs text-gray-400 uppercase">Kategori</label>
                    <select id="modal-provider" class="glass-input p-3 rounded-xl mt-1 bg-black text-white">
                        <!-- Filled by JS -->
                    </select>
                </div>

                <!-- Field: Target Goal -->
                <div id="field-target-goal" class="hidden">
                    <label class="text-xs text-gray-400 uppercase">Target Harga (Rp)</label>
                    <input type="number" id="modal-goal-amount" class="glass-input p-3 rounded-xl mt-1" placeholder="0">
                </div>

                <!-- Field: Contact -->
                <div id="field-contact" class="hidden space-y-3">
                    <div>
                        <label class="text-xs text-gray-400 uppercase">No HP (WA)</label>
                        <input type="tel" id="modal-phone" class="glass-input p-3 rounded-xl mt-1" placeholder="0812...">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 uppercase">Info Lain</label>
                        <input type="text" id="modal-social" class="glass-input p-3 rounded-xl mt-1" placeholder="Opsional">
                    </div>
                </div>

                <!-- Field: Date -->
                <div id="field-date" class="hidden">
                    <label class="text-xs text-gray-400 uppercase">Tanggal</label>
                    <input type="date" id="modal-date" class="glass-input p-3 rounded-xl mt-1 text-white" style="color-scheme: dark;">
                </div>

                <!-- Field: Amount -->
                <div>
                    <label class="text-xs text-gray-400 uppercase" id="label-amount">Nominal / Saldo (Rp)</label>
                    <input type="number" id="modal-amount" class="glass-input p-3 rounded-xl mt-1" placeholder="0">
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="closeModal()" class="flex-1 py-3 rounded-xl bg-white/10 hover:bg-white/20 text-gray-300">Batal</button>
                    <button onclick="saveModalData()" class="flex-1 py-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg shadow-blue-500/30">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TARGET ACTION MODAL (Nabung/Edit) -->
    <div id="target-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[65] flex items-end sm:items-center justify-center">
        <div class="glass-panel w-full sm:max-w-sm rounded-t-3xl sm:rounded-3xl p-6">
             <h3 class="text-lg font-bold mb-2" id="action-target-name">Target</h3>
             <p class="text-xs text-gray-400 mb-4">Tambah tabungan untuk target ini</p>
             <input type="number" id="action-amount" class="glass-input p-3 rounded-xl mb-4" placeholder="Jumlah Nabung">
             <div class="grid grid-cols-2 gap-3">
                 <button onclick="deleteTarget()" class="py-3 rounded-xl bg-red-500/20 text-red-400 hover:bg-red-500/30">Hapus Target</button>
                 <button onclick="saveTargetProgress()" class="py-3 rounded-xl bg-emerald-600 text-white font-bold hover:bg-emerald-500 shadow-lg shadow-emerald-500/30">Nabung</button>
             </div>
             <button onclick="document.getElementById('target-modal').classList.add('hidden')" class="w-full mt-3 py-2 text-gray-500 text-sm">Batal</button>
        </div>
    </div>

    <script>
        // --- DATA STATE ---
        let appData = {
            cash: {}, 
            accounts: [], // type: 'wallet', 'bank' (Digital) OR 'stock', 'crypto', 'gold' (Invest)
            targets: [],  // { id, name, current, goal }
            debts: [],    // { id, type: 'lent'|'borrowed', ... }
            gifts: []
        };

        const denominations = [
            { val: 100000, type: 'paper', label: '100K' }, { val: 50000, type: 'paper', label: '50K' },
            { val: 20000, type: 'paper', label: '20K' }, { val: 10000, type: 'paper', label: '10K' },
            { val: 5000, type: 'paper', label: '5K' }, { val: 2000, type: 'paper', label: '2K' },
            { val: 1000, type: 'paper', label: '1K Kertas' }, { val: 1000, type: 'coin', label: '1K Koin' },
            { val: 500, type: 'coin', label: '500' }, { val: 200, type: 'coin', label: '200' },
            { val: 100, type: 'coin', label: '100' }
        ];

        // --- INIT ---
        function init() {
            // Merge old data structure if needed
            const saved = localStorage.getItem('iFinanceUltimate');
            // Check previous keys to migrate if user comes from older versions
            if (saved) {
                appData = JSON.parse(saved);
            } else {
                // Try migration from older localstorage keys
                const social = localStorage.getItem('iFinanceSocial');
                const glass = localStorage.getItem('iFinanceData');
                if(social) {
                    const old = JSON.parse(social);
                    appData = { ...appData, ...old };
                } else if(glass) {
                    const old = JSON.parse(glass);
                    appData = { ...appData, ...old };
                }
            }
            
            document.getElementById('modal-date').valueAsDate = new Date();

            renderCalculator();
            renderAssets(); // Handles both Wallet & Invest
            renderTargets();
            renderDebts();
            renderGifts();
            updateSummary();
        }

        function saveData() {
            localStorage.setItem('iFinanceUltimate', JSON.stringify(appData));
            updateSummary();
        }

        // --- NAVIGATION ---
        function switchTab(viewName, subTab = null) {
            ['dashboard', 'cash', 'assets', 'target', 'social'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                document.getElementById(`nav-${v}`).classList.remove('active');
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            document.getElementById(`nav-${viewName}`).classList.add('active');

            if (viewName === 'assets' && subTab) {
                switchAssetTab(subTab);
            }
        }

        function switchAssetTab(tab) {
            document.getElementById('asset-wallet-view').classList.add('hidden');
            document.getElementById('asset-invest-view').classList.add('hidden');
            document.getElementById('seg-wallet').classList.remove('active');
            document.getElementById('seg-invest').classList.remove('active');

            document.getElementById(`asset-${tab}-view`).classList.remove('hidden');
            document.getElementById(`seg-${tab}`).classList.add('active');
        }

        function switchSocialTab(tab) {
            document.getElementById('social-debt-view').classList.add('hidden');
            document.getElementById('social-gift-view').classList.add('hidden');
            document.getElementById('seg-debt').classList.remove('active');
            document.getElementById('seg-gift').classList.remove('active');

            document.getElementById(`social-${tab}-view`).classList.remove('hidden');
            document.getElementById(`seg-${tab}`).classList.add('active');
        }

        // --- RENDERERS ---

        // 1. CASH
        function renderCalculator() {
            const container = document.getElementById('money-inputs');
            container.innerHTML = '';
            denominations.forEach(d => {
                const key = `${d.val}-${d.type}`;
                const count = appData.cash[key] || 0;
                container.innerHTML += `
                    <div class="glass-card p-2 rounded-xl flex items-center gap-3">
                        <div class="w-16 font-bold ${d.type === 'paper' ? 'text-emerald-400' : 'text-yellow-400'}">${d.label}</div>
                        <button onclick="updateCash('${key}', -1)" class="w-8 h-8 rounded-lg bg-white/10">-</button>
                        <input type="number" value="${count||''}" placeholder="0" class="flex-1 bg-transparent text-center font-bold text-white focus:outline-none" onchange="setCash('${key}', this.value)">
                        <button onclick="updateCash('${key}', 1)" class="w-8 h-8 rounded-lg bg-white/10">+</button>
                    </div>`;
            });
            calculateCashTotal();
        }

        // 2. ASSETS (Mixed)
        function renderAssets() {
            const walletList = document.getElementById('wallet-list');
            const investList = document.getElementById('invest-list');
            walletList.innerHTML = '';
            investList.innerHTML = '';
            
            let walletTotal = 0;
            let investTotal = 0;

            appData.accounts.forEach(acc => {
                const isInvest = ['stock','crypto','gold','invest'].includes(acc.type);
                const icon = getIcon(acc.type, acc.name);
                
                const html = `
                    <div class="glass-card p-4 rounded-xl flex justify-between items-center group">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-lg">${icon}</div>
                            <div><p class="font-bold">${acc.name}</p><p class="text-xs text-gray-400 capitalize">${translateType(acc.type)}</p></div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${isInvest ? 'text-purple-300' : 'text-blue-300'}">${formatRupiah(acc.balance)}</p>
                            <button onclick="deleteItem('accounts', ${acc.id})" class="text-xs text-red-400 opacity-0 group-hover:opacity-100">Hapus</button>
                        </div>
                    </div>`;

                if(isInvest) {
                    investList.innerHTML += html;
                    investTotal += acc.balance;
                } else {
                    walletList.innerHTML += html;
                    walletTotal += acc.balance;
                }
            });

            document.getElementById('dash-wallet').innerText = formatRupiah(walletTotal);
            document.getElementById('dash-invest').innerText = formatRupiah(investTotal);
        }

        // 3. TARGETS
        function renderTargets() {
            const list = document.getElementById('target-list');
            const dashContent = document.getElementById('dash-target-content');
            list.innerHTML = '';
            
            if(appData.targets.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-500 text-xs mt-10">Mulai buat impian pertamamu!</p>`;
                dashContent.innerHTML = `<p class="text-xs text-gray-500">Belum ada target.</p>`;
                return;
            }

            appData.targets.forEach((t, index) => {
                const percent = Math.min(100, (t.current / t.goal) * 100);
                const isDone = percent >= 100;

                const html = `
                    <div class="glass-card p-4 rounded-xl cursor-pointer hover:bg-white/10" onclick="openTargetAction(${t.id})">
                        <div class="flex justify-between items-end mb-2">
                            <h4 class="font-bold truncate pr-4">${t.name}</h4>
                            <span class="text-xs ${isDone ? 'text-emerald-400' : 'text-blue-400'} font-bold">${Math.round(percent)}%</span>
                        </div>
                        <div class="w-full bg-gray-700/50 h-2 rounded-full overflow-hidden mb-2">
                            <div class="h-full ${isDone ? 'bg-emerald-500' : 'bg-gradient-to-r from-blue-500 to-purple-500'}" style="width: ${percent}%"></div>
                        </div>
                        <div class="flex justify-between text-[10px] text-gray-400">
                            <span>Terkumpul: ${formatRupiah(t.current)}</span>
                            <span>Target: ${formatRupiah(t.goal)}</span>
                        </div>
                    </div>`;
                
                list.innerHTML += html;

                // Dashboard Teaser (Top 1)
                if(index === 0) {
                    dashContent.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-bold truncate">${t.name}</span>
                            <span class="text-xs font-bold text-blue-400">${Math.round(percent)}%</span>
                        </div>
                        <div class="w-full bg-gray-700/50 h-1 rounded-full"><div class="h-full bg-blue-500" style="width: ${percent}%"></div></div>
                    `;
                }
            });
        }

        // 4. SOCIAL (Debts & Gifts)
        function renderDebts() {
            const list = document.getElementById('debt-list');
            list.innerHTML = '';
            let receivableTotal = 0;

            appData.debts.forEach(d => {
                const isLent = d.type === 'lent';
                if(isLent) receivableTotal += d.amount;
                const dateStr = new Date(d.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
                
                // WA Link
                let waBtn = '';
                if(d.phone) {
                    let cleanPhone = d.phone.replace(/^0/, '62').replace(/\D/g,'');
                    waBtn = `<a href="https://wa.me/${cleanPhone}" target="_blank" class="w-8 h-8 rounded-full bg-green-600/20 flex items-center justify-center text-green-400"><i class="fa-brands fa-whatsapp"></i></a>`;
                }

                list.innerHTML += `
                    <div class="glass-card p-4 rounded-xl flex flex-col gap-2 group relative overflow-hidden">
                        <div class="absolute left-0 top-0 bottom-0 w-1 ${isLent ? 'bg-emerald-500' : 'bg-red-500'}"></div>
                        <div class="flex justify-between items-start pl-2">
                            <div>
                                <div class="flex items-center gap-2">
                                    <h4 class="font-bold">${d.name}</h4>
                                    <span class="text-[10px] px-2 py-0.5 rounded ${isLent ? 'bg-emerald-500/20 text-emerald-300' : 'bg-red-500/20 text-red-300'}">${isLent ? 'Dipinjam' : 'Hutang Saya'}</span>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">${dateStr} ${d.social ? 'â€¢ ' + d.social : ''}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold ${isLent ? 'text-emerald-400' : 'text-red-400'}">${formatRupiah(d.amount)}</p>
                                <button onclick="deleteItem('debts', ${d.id})" class="text-xs text-red-400 mt-1 opacity-60 hover:opacity-100">Lunas/Hapus</button>
                            </div>
                        </div>
                        ${waBtn ? `<div class="flex justify-end pt-2 border-t border-white/10 mt-1 gap-2 items-center"><span class="text-[10px] text-gray-500">Tagih:</span> ${waBtn}</div>` : ''}
                    </div>`;
            });
            document.getElementById('dash-receivable').innerText = formatRupiah(receivableTotal);
        }

        function renderGifts() {
            const list = document.getElementById('gift-list');
            list.innerHTML = '';
            appData.gifts.forEach(g => {
                const dateStr = new Date(g.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
                list.innerHTML += `
                    <div class="glass-card p-3 rounded-xl flex items-center gap-3 group">
                        <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-300"><i class="fa-solid fa-gift"></i></div>
                        <div class="flex-1">
                            <p class="font-bold">${g.name}</p>
                            <p class="text-xs text-gray-400">${dateStr}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-purple-300">${formatRupiah(g.amount)}</p>
                            <button onclick="deleteItem('gifts', ${g.id})" class="text-[10px] text-red-400 opacity-0 group-hover:opacity-100">Hapus</button>
                        </div>
                    </div>`;
            });
        }

        // --- MODAL LOGIC ---
        let modalMode = ''; // wallet, invest, target, debt, gift
        let activeTargetId = null;

        function openModal(mode) {
            modalMode = mode;
            document.getElementById('modal').classList.remove('hidden');
            
            // Hide all special fields first
            ['field-provider', 'field-debt-type', 'field-contact', 'field-date', 'field-target-goal'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            
            // Reset Values
            document.getElementById('modal-name').value = '';
            document.getElementById('modal-amount').value = '';
            document.getElementById('label-amount').innerText = "Nominal (Rp)";
            document.getElementById('label-name').innerText = "Nama";

            const title = document.getElementById('modal-title');
            const providerSelect = document.getElementById('modal-provider');

            if (mode === 'wallet') {
                title.innerText = "Tambah Dompet/Bank";
                document.getElementById('field-provider').classList.remove('hidden');
                providerSelect.innerHTML = `<option value="wallet">Dompet Digital (Gopay/OVO)</option><option value="bank">Bank (BCA/Mandiri)</option>`;
                document.getElementById('label-amount').innerText = "Saldo Saat Ini";
            } 
            else if (mode === 'invest') {
                title.innerText = "Tambah Investasi";
                document.getElementById('field-provider').classList.remove('hidden');
                providerSelect.innerHTML = `<option value="stock">Saham / Reksadana</option><option value="crypto">Crypto</option><option value="gold">Emas</option>`;
                document.getElementById('label-amount').innerText = "Nilai Aset Sekarang";
            }
            else if (mode === 'target') {
                title.innerText = "Target Impian Baru";
                document.getElementById('label-name').innerText = "Nama Barang/Tujuan";
                document.getElementById('label-amount').innerText = "Tabungan Awal (Start)";
                document.getElementById('field-target-goal').classList.remove('hidden');
            }
            else if (mode === 'debt') {
                title.innerText = "Catat Hutang/Piutang";
                document.getElementById('field-debt-type').classList.remove('hidden');
                document.getElementById('field-contact').classList.remove('hidden');
                document.getElementById('field-date').classList.remove('hidden');
            } 
            else if (mode === 'gift') {
                title.innerText = "Catat Amplop";
                document.getElementById('field-date').classList.remove('hidden');
            }
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function saveModalData() {
            const name = document.getElementById('modal-name').value;
            const amount = parseInt(document.getElementById('modal-amount').value) || 0;
            const id = Date.now();
            
            if (!name) return alert("Nama wajib diisi!");

            if (modalMode === 'wallet' || modalMode === 'invest') {
                const type = document.getElementById('modal-provider').value;
                appData.accounts.push({ id, name, type, balance: amount });
            } 
            else if (modalMode === 'target') {
                const goal = parseInt(document.getElementById('modal-goal-amount').value) || 0;
                appData.targets.push({ id, name, current: amount, goal });
            }
            else if (modalMode === 'debt') {
                const type = document.querySelector('input[name="debtType"]:checked').value;
                const date = document.getElementById('modal-date').value;
                const phone = document.getElementById('modal-phone').value;
                const social = document.getElementById('modal-social').value;
                appData.debts.unshift({ id, type, name, amount, date, phone, social });
            }
            else if (modalMode === 'gift') {
                const date = document.getElementById('modal-date').value;
                appData.gifts.unshift({ id, name, amount, date });
            }

            saveData();
            closeModal();
            renderAssets(); renderTargets(); renderDebts(); renderGifts();
        }

        // Target Action Logic
        function openTargetAction(id) {
            activeTargetId = id;
            const t = appData.targets.find(x => x.id === id);
            document.getElementById('action-target-name').innerText = t.name;
            document.getElementById('action-amount').value = '';
            document.getElementById('target-modal').classList.remove('hidden');
        }

        function saveTargetProgress() {
            const amount = parseInt(document.getElementById('action-amount').value) || 0;
            const t = appData.targets.find(x => x.id === activeTargetId);
            if(t) {
                t.current += amount;
                saveData();
                renderTargets();
                document.getElementById('target-modal').classList.add('hidden');
            }
        }

        function deleteTarget() {
            if(confirm("Hapus impian ini?")) {
                appData.targets = appData.targets.filter(t => t.id !== activeTargetId);
                saveData();
                renderTargets();
                document.getElementById('target-modal').classList.add('hidden');
            }
        }

        // --- CORE & UTILS ---
        function updateCash(key, delta) {
            const current = appData.cash[key] || 0;
            let next = current + delta;
            if (next < 0) next = 0;
            appData.cash[key] = next;
            renderCalculator();
            saveData();
        }
        function setCash(key, val) {
            let num = parseInt(val) || 0;
            if(num < 0) num = 0;
            appData.cash[key] = num;
            renderCalculator();
            saveData();
        }
        function calculateCashTotal() {
            let total = 0;
            denominations.forEach(d => total += (appData.cash[`${d.val}-${d.type}`] || 0) * d.val);
            document.getElementById('calc-total').innerText = formatRupiah(total);
            document.getElementById('dash-cash').innerText = formatRupiah(total);
            return total;
        }

        function deleteItem(arrName, id) {
            if(confirm("Hapus data ini?")) {
                appData[arrName] = appData[arrName].filter(x => x.id !== id);
                saveData();
                renderAssets(); renderDebts(); renderGifts();
            }
        }

        function updateSummary() {
            const cash = calculateCashTotal();
            const assets = appData.accounts.reduce((acc, curr) => acc + curr.balance, 0);
            const targets = appData.targets.reduce((acc, curr) => acc + curr.current, 0); // Include savings in targets as assets
            const piutang = appData.debts.filter(d => d.type === 'lent').reduce((acc, curr) => acc + curr.amount, 0);
            const hutang = appData.debts.filter(d => d.type === 'borrowed').reduce((acc, curr) => acc + curr.amount, 0);

            // Net Worth = Cash + Bank/Invest + TargetSavings + Piutang - Hutang
            const netWorth = cash + assets + targets + piutang - hutang;
            document.getElementById('header-net-worth').innerText = formatRupiah(netWorth);
        }

        function formatRupiah(num) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
        }

        function getIcon(type, name) {
            if (name.toLowerCase().includes('bca')) return '<i class="fa-solid fa-building-columns text-blue-500"></i>';
            if (name.toLowerCase().includes('gopay')) return '<i class="fa-solid fa-wallet text-blue-400"></i>';
            if (type === 'crypto') return '<i class="fa-brands fa-bitcoin text-yellow-500"></i>';
            if (type === 'stock') return '<i class="fa-solid fa-chart-line text-green-500"></i>';
            if (type === 'gold') return '<i class="fa-solid fa-ring text-yellow-300"></i>';
            return '<i class="fa-solid fa-sack-dollar text-gray-400"></i>';
        }

        function translateType(t) {
            const map = { 'wallet': 'Dompet Digital', 'bank': 'Bank', 'stock': 'Saham', 'crypto': 'Crypto', 'gold': 'Emas' };
            return map[t] || t;
        }

        init();
    </script>
</body>
</html>

