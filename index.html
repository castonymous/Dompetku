<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iFinance Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&family=Inter:wght@400;600&display=swap');

        /* --- THEME CONFIG --- */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #000;
            color: white;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 110px;
        }

        /* Fluid Background */
        .ambient-light {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1;
            background: 
                radial-gradient(circle at 10% 20%, rgba(68, 55, 255, 0.4) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255, 48, 100, 0.3) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(48, 207, 255, 0.2) 0%, transparent 60%);
            filter: blur(60px);
            animation: pulse 10s infinite alternate;
        }
        @keyframes pulse { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }

        /* Glass UI */
        .glass-panel {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }
        .glass-card:active { transform: scale(0.98); background: rgba(255, 255, 255, 0.1); }
        
        .glass-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            width: 100%;
        }
        .glass-input:focus { outline: none; border-color: rgba(96, 165, 250, 0.5); background: rgba(0, 0, 0, 0.6); }

        /* Segment Control */
        .segment-control {
            background: rgba(0,0,0,0.3);
            padding: 4px;
            border-radius: 12px;
            display: flex;
            margin-bottom: 15px;
        }
        .segment-btn {
            flex: 1;
            text-align: center;
            padding: 8px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 8px;
            color: #9ca3af;
            transition: all 0.3s;
        }
        .segment-btn.active {
            background: rgba(255,255,255,0.15);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Bottom Dock */
        .dock {
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: max(15px, env(safe-area-inset-bottom));
        }
        .nav-item { transition: all 0.3s; opacity: 0.5; }
        .nav-item.active { opacity: 1; transform: translateY(-2px); }
        .nav-item.active i { color: #60a5fa; text-shadow: 0 0 10px rgba(96, 165, 250, 0.6); }

        /* Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div class="ambient-light"></div>

    <!-- Header -->
    <header class="sticky top-0 z-40 pt-4 pb-2 px-5 glass-panel border-t-0 border-x-0 rounded-b-3xl mb-4">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-cyan-500 flex items-center justify-center shadow-lg shadow-indigo-500/30">
                    <i class="fa-brands fa-apple text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg tracking-tight">iFinance</h1>
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest">Pro Edition</p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-gray-400 text-xs mb-1">Total Net Worth</p>
                <h2 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-300 to-cyan-300" id="header-net-worth">Rp 0</h2>
            </div>
        </div>
    </header>

    <main class="px-4 min-h-screen">

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="space-y-4 animate-fade-in">
            
            <!-- Quick Actions (New) -->
            <div class="flex gap-3 mb-2">
                <button onclick="openTransactionModal('in')" class="flex-1 bg-emerald-600/20 border border-emerald-500/30 py-3 rounded-xl flex items-center justify-center gap-2 hover:bg-emerald-600/30 active:scale-95 transition">
                    <div class="w-6 h-6 rounded-full bg-emerald-500 flex items-center justify-center text-white text-xs"><i class="fa-solid fa-arrow-down"></i></div>
                    <span class="text-sm font-bold text-emerald-100">Pemasukan</span>
                </button>
                <button onclick="openTransactionModal('out')" class="flex-1 bg-rose-600/20 border border-rose-500/30 py-3 rounded-xl flex items-center justify-center gap-2 hover:bg-rose-600/30 active:scale-95 transition">
                    <div class="w-6 h-6 rounded-full bg-rose-500 flex items-center justify-center text-white text-xs"><i class="fa-solid fa-arrow-up"></i></div>
                    <span class="text-sm font-bold text-rose-100">Pengeluaran</span>
                </button>
            </div>

            <!-- Asset Grid -->
            <div class="grid grid-cols-2 gap-3">
                <div class="glass-card p-3 rounded-2xl h-24 relative overflow-hidden group" onclick="switchTab('cash')">
                    <div class="absolute -right-2 -bottom-2 text-6xl text-emerald-500/10"><i class="fa-solid fa-money-bill"></i></div>
                    <p class="text-xs text-gray-400">Cash Fisik</p>
                    <p class="font-bold text-lg mt-1" id="dash-cash">Rp 0</p>
                </div>
                <div class="glass-card p-3 rounded-2xl h-24 relative overflow-hidden group" onclick="switchTab('assets')">
                    <div class="absolute -right-2 -bottom-2 text-6xl text-blue-500/10"><i class="fa-solid fa-wallet"></i></div>
                    <p class="text-xs text-gray-400">Aset Digital</p>
                    <p class="font-bold text-lg mt-1" id="dash-wallet">Rp 0</p>
                </div>
                <div class="glass-card p-3 rounded-2xl h-24 relative overflow-hidden group" onclick="switchTab('assets', 'invest')">
                    <div class="absolute -right-2 -bottom-2 text-6xl text-purple-500/10"><i class="fa-solid fa-chart-pie"></i></div>
                    <p class="text-xs text-gray-400">Investasi</p>
                    <p class="font-bold text-lg mt-1" id="dash-invest">Rp 0</p>
                </div>
                <div class="glass-card p-3 rounded-2xl h-24 relative overflow-hidden group" onclick="switchTab('social')">
                    <div class="absolute -right-2 -bottom-2 text-6xl text-orange-500/10"><i class="fa-solid fa-handshake"></i></div>
                    <p class="text-xs text-gray-400">Piutang</p>
                    <p class="font-bold text-lg mt-1" id="dash-receivable">Rp 0</p>
                </div>
            </div>

            <!-- Total Kondangan (Display Only) -->
            <div class="glass-card p-3 rounded-2xl flex justify-between items-center" onclick="switchTab('social', 'gift')">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-pink-500/20 flex items-center justify-center text-pink-400"><i class="fa-solid fa-envelope-open-text"></i></div>
                    <div>
                        <p class="text-xs text-gray-400">Total Amplop Keluar</p>
                        <p class="font-bold text-pink-200" id="dash-gifts">Rp 0</p>
                    </div>
                </div>
                <i class="fa-solid fa-chevron-right text-xs text-gray-600"></i>
            </div>

            <!-- Recent Transactions Teaser -->
            <div class="mt-4">
                <h3 class="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wider">Mutasi Terakhir</h3>
                <div id="dashboard-transactions" class="space-y-2">
                    <!-- JS Injected -->
                </div>
            </div>
        </div>

        <!-- VIEW: CASH -->
        <div id="view-cash" class="hidden space-y-5">
            <div class="glass-panel p-5 rounded-3xl text-center relative overflow-hidden">
                 <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 to-green-300"></div>
                 <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Total Fisik</p>
                 <h2 class="text-3xl font-bold text-emerald-300" id="calc-total">Rp 0</h2>
            </div>
            <div class="space-y-2" id="money-inputs">
                <!-- Cleaner Layout via JS -->
            </div>
        </div>

        <!-- VIEW: ASSETS -->
        <div id="view-assets" class="hidden space-y-5">
            <div class="segment-control">
                <button onclick="switchAssetTab('wallet')" id="seg-wallet" class="segment-btn active">Dompet / Bank</button>
                <button onclick="switchAssetTab('invest')" id="seg-invest" class="segment-btn">Investasi</button>
            </div>

            <!-- Tab: Wallet -->
            <div id="asset-wallet-view" class="space-y-4">
                <div class="flex justify-between items-center px-1">
                    <p class="text-xs text-gray-400">Liquid Assets</p>
                    <button onclick="openModal('wallet')" class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white hover:scale-110 transition"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div id="wallet-list" class="space-y-3"></div>
            </div>

            <!-- Tab: Invest -->
            <div id="asset-invest-view" class="hidden space-y-4">
                <div class="flex justify-between items-center px-1">
                    <p class="text-xs text-gray-400">Growth Assets</p>
                    <button onclick="openModal('invest')" class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center text-white hover:scale-110 transition"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div id="invest-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- VIEW: TARGETS -->
        <div id="view-target" class="hidden space-y-5">
            <div class="glass-panel p-4 rounded-2xl flex justify-between items-center">
                <div><h3 class="font-bold">Target Impian</h3><p class="text-xs text-gray-400">Goals</p></div>
                <button onclick="openModal('target')" class="bg-white/10 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-white/20">+ Target</button>
            </div>
            <div id="target-list" class="space-y-4 pb-10"></div>
        </div>

        <!-- VIEW: SOCIAL -->
        <div id="view-social" class="hidden space-y-5">
            <div class="segment-control">
                <button onclick="switchSocialTab('debt')" id="seg-debt" class="segment-btn active">Hutang</button>
                <button onclick="switchSocialTab('gift')" id="seg-gift" class="segment-btn">Kondangan</button>
            </div>

            <div id="social-debt-view" class="space-y-4">
                <div class="flex justify-between items-center px-1">
                    <p class="text-xs text-gray-400">Catatan Pinjaman</p>
                    <button onclick="openModal('debt')" class="bg-white/10 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-white/20">+ Catat</button>
                </div>
                <div id="debt-list" class="space-y-3"></div>
            </div>

            <div id="social-gift-view" class="hidden space-y-4">
                <div class="flex justify-between items-center px-1">
                    <p class="text-xs text-gray-400">Amplop Keluar</p>
                    <button onclick="openModal('gift')" class="bg-pink-500/20 text-pink-300 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-pink-500/30">+ Amplop</button>
                </div>
                <div id="gift-list" class="space-y-3"></div>
            </div>
        </div>

    </main>

    <!-- DOCK NAVIGATION -->
    <nav class="dock fixed bottom-0 left-0 right-0 px-2 pt-3 flex justify-around items-center z-50 rounded-t-3xl">
        <button onclick="switchTab('dashboard')" class="nav-item active flex flex-col items-center gap-1 w-1/5" id="nav-dashboard">
            <i class="fa-solid fa-house text-xl"></i><span class="text-[10px] font-medium">Home</span>
        </button>
        <button onclick="switchTab('cash')" class="nav-item flex flex-col items-center gap-1 w-1/5" id="nav-cash">
            <i class="fa-solid fa-money-bill text-xl"></i><span class="text-[10px] font-medium">Cash</span>
        </button>
        <button onclick="switchTab('assets')" class="nav-item flex flex-col items-center gap-1 w-1/5" id="nav-assets">
            <i class="fa-solid fa-wallet text-xl"></i><span class="text-[10px] font-medium">Aset</span>
        </button>
        <button onclick="switchTab('target')" class="nav-item flex flex-col items-center gap-1 w-1/5" id="nav-target">
            <i class="fa-solid fa-bullseye text-xl"></i><span class="text-[10px] font-medium">Target</span>
        </button>
        <button onclick="switchTab('social')" class="nav-item flex flex-col items-center gap-1 w-1/5" id="nav-social">
            <i class="fa-solid fa-users text-xl"></i><span class="text-[10px] font-medium">Sosial</span>
        </button>
    </nav>

    <!-- MASTER MODAL (Universal) -->
    <div id="modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[60] flex items-end sm:items-center justify-center">
        <div class="glass-panel w-full sm:max-w-sm rounded-t-3xl sm:rounded-3xl p-6 transform transition-transform duration-300 scale-100">
            <div class="w-12 h-1 bg-gray-600 rounded-full mx-auto mb-6"></div>
            <h3 class="text-xl font-bold mb-4" id="modal-title">Form</h3>
            
            <div class="space-y-4 max-h-[70vh] overflow-y-auto no-scrollbar">
                
                <!-- Field: Debt Type -->
                <div id="field-debt-type" class="hidden mb-2">
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="debtType" value="lent" class="peer sr-only" checked>
                            <div class="glass-input p-3 rounded-xl text-center peer-checked:bg-emerald-600/50 peer-checked:border-emerald-500 border border-transparent">
                                <span class="text-xs font-bold block">Dipinjam</span><span class="text-[10px] opacity-70">(Aset Saya)</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="debtType" value="borrowed" class="peer sr-only">
                            <div class="glass-input p-3 rounded-xl text-center peer-checked:bg-red-600/50 peer-checked:border-red-500 border border-transparent">
                                <span class="text-xs font-bold block">Saya Hutang</span><span class="text-[10px] opacity-70">(Kewajiban)</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Field: Name -->
                <div id="field-name">
                    <label class="text-xs text-gray-400 uppercase" id="label-name">Nama</label>
                    <input type="text" id="modal-name" class="glass-input p-3 rounded-xl mt-1" placeholder="Isi nama...">
                </div>

                <!-- Field: Provider Type -->
                <div id="field-provider" class="hidden">
                    <label class="text-xs text-gray-400 uppercase">Kategori</label>
                    <select id="modal-provider" class="glass-input p-3 rounded-xl mt-1 bg-black text-white">
                        <!-- Filled by JS -->
                    </select>
                </div>

                <!-- Field: Target Goal -->
                <div id="field-target-goal" class="hidden">
                    <label class="text-xs text-gray-400 uppercase">Target Harga</label>
                    <input type="text" inputmode="numeric" id="modal-goal-amount" class="glass-input p-3 rounded-xl mt-1" placeholder="0" oninput="formatInput(this)">
                </div>

                <!-- Field: Contact -->
                <div id="field-contact" class="hidden space-y-3">
                    <div>
                        <label class="text-xs text-gray-400 uppercase">No HP (WA)</label>
                        <input type="tel" id="modal-phone" class="glass-input p-3 rounded-xl mt-1" placeholder="0812...">
                    </div>
                </div>

                <!-- Field: Date -->
                <div id="field-date" class="hidden">
                    <label class="text-xs text-gray-400 uppercase">Tanggal</label>
                    <input type="date" id="modal-date" class="glass-input p-3 rounded-xl mt-1 text-white" style="color-scheme: dark;">
                </div>

                <!-- Field: Amount -->
                <div id="field-amount">
                    <label class="text-xs text-gray-400 uppercase" id="label-amount">Nominal (Rp)</label>
                    <input type="text" inputmode="numeric" id="modal-amount" class="glass-input p-3 rounded-xl mt-1 font-bold text-lg" placeholder="0" oninput="formatInput(this)">
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="closeModal()" class="flex-1 py-3 rounded-xl bg-white/10 hover:bg-white/20 text-gray-300">Batal</button>
                    <button onclick="saveModalData()" class="flex-1 py-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg shadow-blue-500/30" id="btn-save-modal">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TRANSACTION MODAL (New) -->
    <div id="trx-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[65] flex items-end sm:items-center justify-center">
        <div class="glass-panel w-full sm:max-w-sm rounded-t-3xl sm:rounded-3xl p-6">
            <h3 class="text-lg font-bold mb-4" id="trx-title">Transaksi</h3>
            
            <div class="space-y-4">
                <!-- Source Selector -->
                <div>
                    <label class="text-xs text-gray-400 uppercase">Sumber Dana</label>
                    <select id="trx-source" class="glass-input p-3 rounded-xl mt-1 bg-black text-white">
                        <option value="cash">Cash (Uang Fisik)</option>
                        <!-- Accounts filled by JS -->
                    </select>
                    <p class="text-[10px] text-gray-500 mt-1" id="trx-hint">*Saldo akun akan berkurang/bertambah otomatis. Cash hanya dicatat.</p>
                </div>

                <div>
                    <label class="text-xs text-gray-400 uppercase">Keterangan</label>
                    <input type="text" id="trx-note" class="glass-input p-3 rounded-xl mt-1" placeholder="cth: Beli Kopi / Gaji">
                </div>

                <div>
                    <label class="text-xs text-gray-400 uppercase">Nominal</label>
                    <input type="text" inputmode="numeric" id="trx-amount" class="glass-input p-3 rounded-xl mt-1 font-bold text-lg" placeholder="0" oninput="formatInput(this)">
                </div>

                <div class="flex gap-3 mt-4">
                    <button onclick="closeTrxModal()" class="flex-1 py-3 rounded-xl bg-white/10 text-gray-400">Batal</button>
                    <button onclick="saveTransaction()" class="flex-1 py-3 rounded-xl bg-emerald-600 text-white font-bold" id="btn-save-trx">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TARGET ACTION MODAL -->
    <div id="target-action-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[65] flex items-end sm:items-center justify-center">
        <div class="glass-panel w-full sm:max-w-sm rounded-t-3xl sm:rounded-3xl p-6">
             <h3 class="text-lg font-bold mb-2" id="action-target-name">Target</h3>
             <input type="text" inputmode="numeric" id="action-amount" class="glass-input p-3 rounded-xl mb-4" placeholder="Jumlah Nabung" oninput="formatInput(this)">
             <div class="grid grid-cols-2 gap-3">
                 <button onclick="deleteItem('targets', activeTargetId)" class="py-3 rounded-xl bg-red-500/20 text-red-400">Hapus</button>
                 <button onclick="saveTargetProgress()" class="py-3 rounded-xl bg-emerald-600 text-white font-bold">Nabung</button>
             </div>
             <button onclick="document.getElementById('target-action-modal').classList.add('hidden')" class="w-full mt-3 py-2 text-gray-500 text-sm">Batal</button>
        </div>
    </div>

    <script>
        // --- DATA STATE ---
        let appData = {
            cash: {}, 
            accounts: [], 
            targets: [], 
            debts: [], 
            gifts: [],
            transactions: [] // New: Log History
        };

        let editingId = null; // For Edit Mode
        let activeTargetId = null;
        let trxType = 'out'; // 'in' or 'out'

        const denominations = [
            { val: 100000, type: 'paper', label: '100K' }, { val: 50000, type: 'paper', label: '50K' },
            { val: 20000, type: 'paper', label: '20K' }, { val: 10000, type: 'paper', label: '10K' },
            { val: 5000, type: 'paper', label: '5K' }, { val: 2000, type: 'paper', label: '2K' },
            { val: 1000, type: 'paper', label: '1K Kertas' }, { val: 1000, type: 'coin', label: '1K Koin' },
            { val: 500, type: 'coin', label: '500' }, { val: 200, type: 'coin', label: '200' },
            { val: 100, type: 'coin', label: '100' }
        ];

        // --- INIT ---
        function init() {
            const saved = localStorage.getItem('iFinancePro');
            if (saved) {
                appData = JSON.parse(saved);
                if(!appData.transactions) appData.transactions = []; // migration
            } else {
                // Try legacy migration
                const old = localStorage.getItem('iFinanceUltimate');
                if(old) appData = { ...appData, ...JSON.parse(old) };
            }
            
            document.getElementById('modal-date').valueAsDate = new Date();

            renderCalculator();
            renderAssets();
            renderTargets();
            renderDebts();
            renderGifts();
            renderDashboardTrx();
            updateSummary();
        }

        function saveData() {
            localStorage.setItem('iFinancePro', JSON.stringify(appData));
            updateSummary();
        }

        // --- UI FORMATTERS ---
        function formatInput(input) {
            // Remove non-digit characters
            let val = input.value.replace(/\D/g, '');
            if (val === '') {
                input.value = '';
                return;
            }
            // Add dots
            input.value = new Intl.NumberFormat('id-ID').format(val);
        }

        function getRawValue(inputOrId) {
            const el = typeof inputOrId === 'string' ? document.getElementById(inputOrId) : inputOrId;
            return parseInt(el.value.replace(/\./g, '')) || 0;
        }

        function formatRupiah(num) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
        }

        // --- NAVIGATION ---
        function switchTab(viewName, subTab = null) {
            ['dashboard', 'cash', 'assets', 'target', 'social'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                document.getElementById(`nav-${v}`).classList.remove('active');
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            document.getElementById(`nav-${viewName}`).classList.add('active');

            if (viewName === 'assets' && subTab) switchAssetTab(subTab);
            else if (viewName === 'social' && subTab) switchSocialTab(subTab);
        }

        function switchAssetTab(tab) {
            document.getElementById('asset-wallet-view').classList.add('hidden');
            document.getElementById('asset-invest-view').classList.add('hidden');
            document.getElementById('seg-wallet').classList.remove('active');
            document.getElementById('seg-invest').classList.remove('active');
            document.getElementById(`asset-${tab}-view`).classList.remove('hidden');
            document.getElementById(`seg-${tab}`).classList.add('active');
        }

        function switchSocialTab(tab) {
            document.getElementById('social-debt-view').classList.add('hidden');
            document.getElementById('social-gift-view').classList.add('hidden');
            document.getElementById('seg-debt').classList.remove('active');
            document.getElementById('seg-gift').classList.remove('active');
            document.getElementById(`social-${tab}-view`).classList.remove('hidden');
            document.getElementById(`seg-${tab}`).classList.add('active');
        }

        // --- RENDERERS ---

        function renderCalculator() {
            const container = document.getElementById('money-inputs');
            container.innerHTML = '';
            denominations.forEach(d => {
                const key = `${d.val}-${d.type}`;
                const count = appData.cash[key] || 0;
                // NEW LAYOUT: Wider inputs, better spacing
                container.innerHTML += `
                    <div class="glass-card p-3 rounded-xl flex items-center justify-between gap-3">
                        <div class="flex flex-col w-20">
                            <span class="font-bold ${d.type === 'paper' ? 'text-emerald-400' : 'text-yellow-400'} text-lg">${d.label}</span>
                        </div>
                        <div class="flex items-center gap-2 bg-black/30 rounded-lg p-1 flex-1">
                            <button onclick="updateCash('${key}', -1)" class="w-10 h-10 rounded-lg bg-white/10 active:bg-white/20 font-bold">-</button>
                            <input type="number" value="${count||''}" placeholder="0" class="flex-1 bg-transparent text-center font-bold text-white focus:outline-none text-lg min-w-0" onchange="setCash('${key}', this.value)">
                            <button onclick="updateCash('${key}', 1)" class="w-10 h-10 rounded-lg bg-white/10 active:bg-white/20 font-bold">+</button>
                        </div>
                    </div>`;
            });
            calculateCashTotal();
        }

        function renderAssets() {
            const walletList = document.getElementById('wallet-list');
            const investList = document.getElementById('invest-list');
            walletList.innerHTML = ''; investList.innerHTML = '';
            let walletTotal = 0, investTotal = 0;

            appData.accounts.forEach(acc => {
                const isInvest = ['stock','crypto','gold','invest'].includes(acc.type);
                const html = `
                    <div class="glass-card p-4 rounded-xl flex justify-between items-center group relative">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-lg">${getIcon(acc.type, acc.name)}</div>
                            <div><p class="font-bold">${acc.name}</p><p class="text-xs text-gray-400 capitalize">${translateType(acc.type)}</p></div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${isInvest ? 'text-purple-300' : 'text-blue-300'}">${formatRupiah(acc.balance)}</p>
                            <div class="flex justify-end gap-3 mt-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="openModal('wallet', ${acc.id})" class="text-xs text-blue-400"><i class="fa-solid fa-pen"></i> Edit</button>
                                <button onclick="deleteItem('accounts', ${acc.id})" class="text-xs text-red-400"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>`;
                if(isInvest) { investList.innerHTML += html; investTotal += acc.balance; }
                else { walletList.innerHTML += html; walletTotal += acc.balance; }
            });
            document.getElementById('dash-wallet').innerText = formatRupiah(walletTotal);
            document.getElementById('dash-invest').innerText = formatRupiah(investTotal);
        }

        function renderDebts() {
            const list = document.getElementById('debt-list');
            list.innerHTML = '';
            let receivableTotal = 0;

            appData.debts.forEach(d => {
                const isLent = d.type === 'lent';
                if(isLent) receivableTotal += d.amount;
                const dateStr = new Date(d.date).toLocaleDateString('id-ID', {day:'numeric', month:'short'});
                let waBtn = d.phone ? `<a href="https://wa.me/${d.phone.replace(/^0/, '62').replace(/\D/g,'')}" target="_blank" class="w-8 h-8 rounded-full bg-green-600/20 flex items-center justify-center text-green-400"><i class="fa-brands fa-whatsapp"></i></a>` : '';

                list.innerHTML += `
                    <div class="glass-card p-4 rounded-xl flex flex-col gap-2 group relative overflow-hidden">
                        <div class="absolute left-0 top-0 bottom-0 w-1 ${isLent ? 'bg-emerald-500' : 'bg-red-500'}"></div>
                        <div class="flex justify-between items-start pl-2">
                            <div>
                                <div class="flex items-center gap-2">
                                    <h4 class="font-bold">${d.name}</h4>
                                    <span class="text-[10px] px-2 py-0.5 rounded ${isLent ? 'bg-emerald-500/20 text-emerald-300' : 'bg-red-500/20 text-red-300'}">${isLent ? 'Dipinjam' : 'Hutang Saya'}</span>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">${dateStr} ${d.social ? 'â€¢ ' + d.social : ''}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold ${isLent ? 'text-emerald-400' : 'text-red-400'}">${formatRupiah(d.amount)}</p>
                                <div class="flex justify-end gap-3 mt-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="openModal('debt', ${d.id})" class="text-xs text-blue-400"><i class="fa-solid fa-pen"></i> Edit</button>
                                    <button onclick="deleteItem('debts', ${d.id})" class="text-xs text-red-400"><i class="fa-solid fa-check"></i> Lunas</button>
                                </div>
                            </div>
                        </div>
                        ${waBtn ? `<div class="flex justify-end pt-2 border-t border-white/10 mt-1 gap-2 items-center"><span class="text-[10px] text-gray-500">Tagih:</span> ${waBtn}</div>` : ''}
                    </div>`;
            });
            document.getElementById('dash-receivable').innerText = formatRupiah(receivableTotal);
        }

        function renderGifts() {
            const list = document.getElementById('gift-list');
            list.innerHTML = '';
            let totalGifts = 0;
            appData.gifts.forEach(g => {
                totalGifts += g.amount;
                const dateStr = new Date(g.date).toLocaleDateString('id-ID', {day:'numeric', month:'short', year:'numeric'});
                list.innerHTML += `
                    <div class="glass-card p-3 rounded-xl flex items-center gap-3 group relative">
                        <div class="w-10 h-10 rounded-full bg-pink-500/20 flex items-center justify-center text-pink-300"><i class="fa-solid fa-gift"></i></div>
                        <div class="flex-1">
                            <p class="font-bold">${g.name}</p>
                            <p class="text-xs text-gray-400">${dateStr}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-pink-300">${formatRupiah(g.amount)}</p>
                            <div class="flex justify-end gap-3 mt-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="openModal('gift', ${g.id})" class="text-xs text-blue-400">Edit</button>
                                <button onclick="deleteItem('gifts', ${g.id})" class="text-xs text-red-400">Hapus</button>
                            </div>
                        </div>
                    </div>`;
            });
            document.getElementById('dash-gifts').innerText = formatRupiah(totalGifts);
        }

        function renderTargets() {
            const list = document.getElementById('target-list');
            list.innerHTML = '';
            appData.targets.forEach(t => {
                const percent = Math.min(100, (t.current / t.goal) * 100);
                const isDone = percent >= 100;
                list.innerHTML += `
                    <div class="glass-card p-4 rounded-xl cursor-pointer hover:bg-white/10" onclick="openTargetAction(${t.id})">
                        <div class="flex justify-between items-end mb-2">
                            <h4 class="font-bold truncate pr-4">${t.name}</h4>
                            <span class="text-xs ${isDone ? 'text-emerald-400' : 'text-blue-400'} font-bold">${Math.round(percent)}%</span>
                        </div>
                        <div class="w-full bg-gray-700/50 h-2 rounded-full overflow-hidden mb-2">
                            <div class="h-full ${isDone ? 'bg-emerald-500' : 'bg-blue-500'}" style="width: ${percent}%"></div>
                        </div>
                        <div class="flex justify-between text-[10px] text-gray-400">
                            <span>Terkumpul: ${formatRupiah(t.current)}</span>
                            <span>Target: ${formatRupiah(t.goal)}</span>
                        </div>
                    </div>`;
            });
        }
        
        function renderDashboardTrx() {
            const container = document.getElementById('dashboard-transactions');
            container.innerHTML = '';
            const recent = appData.transactions.slice(0, 3);
            if(recent.length === 0) container.innerHTML = '<p class="text-xs text-gray-600 italic">Belum ada transaksi</p>';
            
            recent.forEach(tx => {
                const isOut = tx.type === 'out';
                const color = isOut ? 'text-rose-400' : 'text-emerald-400';
                const sign = isOut ? '-' : '+';
                container.innerHTML += `
                    <div class="flex justify-between items-center py-2 border-b border-white/5 last:border-0">
                        <div>
                            <p class="text-sm font-bold text-gray-200">${tx.note}</p>
                            <p class="text-[10px] text-gray-500">${tx.sourceLabel}</p>
                        </div>
                        <p class="text-sm font-bold ${color}">${sign} ${formatRupiah(tx.amount)}</p>
                    </div>
                `;
            });
        }

        // --- TRANSACTION LOGIC ---
        function openTransactionModal(type) {
            trxType = type;
            document.getElementById('trx-modal').classList.remove('hidden');
            document.getElementById('trx-title').innerText = type === 'in' ? "Catat Pemasukan" : "Catat Pengeluaran";
            document.getElementById('btn-save-trx').className = `flex-1 py-3 rounded-xl text-white font-bold ${type === 'in' ? 'bg-emerald-600' : 'bg-rose-600'}`;
            
            // Populate Source
            const select = document.getElementById('trx-source');
            select.innerHTML = '<option value="cash">Cash (Uang Fisik)</option>';
            appData.accounts.forEach(acc => {
                select.innerHTML += `<option value="${acc.id}">${acc.name} (${translateType(acc.type)})</option>`;
            });
            
            document.getElementById('trx-amount').value = '';
            document.getElementById('trx-note').value = '';
        }

        function closeTrxModal() { document.getElementById('trx-modal').classList.add('hidden'); }

        function saveTransaction() {
            const amount = getRawValue('trx-amount');
            const note = document.getElementById('trx-note').value || (trxType === 'in' ? 'Pemasukan' : 'Pengeluaran');
            const sourceId = document.getElementById('trx-source').value;
            
            if(amount <= 0) return alert("Nominal harus > 0");

            // Logic: Update Balance if Account
            let sourceLabel = 'Cash';
            if (sourceId !== 'cash') {
                const accIndex = appData.accounts.findIndex(a => a.id == sourceId);
                if (accIndex > -1) {
                    sourceLabel = appData.accounts[accIndex].name;
                    if (trxType === 'out') appData.accounts[accIndex].balance -= amount;
                    else appData.accounts[accIndex].balance += amount;
                }
            } else {
                // If Cash, we don't automatically update calculator because we don't know denominations.
                // Just logging it.
            }

            // Save Log
            appData.transactions.unshift({
                id: Date.now(),
                date: new Date().toISOString(),
                type: trxType,
                amount,
                note,
                sourceId,
                sourceLabel
            });

            saveData();
            renderAssets();
            renderDashboardTrx();
            closeTrxModal();
        }

        // --- EDIT & MODAL LOGIC ---
        let modalMode = ''; 
        
        function openModal(mode, editId = null) {
            modalMode = mode;
            editingId = editId;
            document.getElementById('modal').classList.remove('hidden');
            
            // Reset Fields
            ['field-provider', 'field-debt-type', 'field-contact', 'field-date', 'field-target-goal'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById('modal-name').value = '';
            document.getElementById('modal-amount').value = '';
            
            let title = '';
            let existingData = null;

            // CHECK EDIT MODE
            if (editId) {
                if (mode === 'wallet' || mode === 'invest') existingData = appData.accounts.find(x => x.id === editId);
                else if (mode === 'debt') existingData = appData.debts.find(x => x.id === editId);
                else if (mode === 'gift') existingData = appData.gifts.find(x => x.id === editId);
                
                if(existingData) {
                    document.getElementById('modal-name').value = existingData.name;
                    document.getElementById('modal-amount').value = new Intl.NumberFormat('id-ID').format(existingData.amount || existingData.balance);
                }
            }

            // SETUP FORM
            const pSelect = document.getElementById('modal-provider');
            if (mode === 'wallet') {
                title = editId ? "Edit Akun" : "Tambah Akun";
                document.getElementById('field-provider').classList.remove('hidden');
                pSelect.innerHTML = `<option value="wallet">Dompet Digital</option><option value="bank">Bank</option>`;
                if(editId) pSelect.value = existingData.type;
            } else if (mode === 'invest') {
                title = editId ? "Edit Investasi" : "Tambah Investasi";
                document.getElementById('field-provider').classList.remove('hidden');
                pSelect.innerHTML = `<option value="stock">Saham</option><option value="crypto">Crypto</option><option value="gold">Emas</option>`;
                if(editId) pSelect.value = existingData.type;
            } else if (mode === 'debt') {
                title = editId ? "Edit Hutang" : "Catat Hutang";
                document.getElementById('field-debt-type').classList.remove('hidden');
                document.getElementById('field-contact').classList.remove('hidden');
                document.getElementById('field-date').classList.remove('hidden');
                if(editId) {
                    document.getElementById('modal-phone').value = existingData.phone || '';
                    document.getElementById('modal-date').value = existingData.date;
                    // Radio button logic
                    document.querySelector(`input[name="debtType"][value="${existingData.type}"]`).checked = true;
                }
            } else if (mode === 'gift') {
                title = editId ? "Edit Amplop" : "Catat Amplop";
                document.getElementById('field-date').classList.remove('hidden');
                if(editId) document.getElementById('modal-date').value = existingData.date;
            } else if (mode === 'target') {
                title = "Target Impian";
                document.getElementById('field-target-goal').classList.remove('hidden');
            }

            document.getElementById('modal-title').innerText = title;
            document.getElementById('btn-save-modal').innerText = editId ? "Update" : "Simpan";
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function saveModalData() {
            const name = document.getElementById('modal-name').value;
            const amount = getRawValue('modal-amount');
            if (!name) return alert("Nama wajib diisi!");

            // EDIT EXISTING
            if (editingId) {
                if (modalMode === 'wallet' || modalMode === 'invest') {
                    const acc = appData.accounts.find(x => x.id === editingId);
                    acc.name = name;
                    acc.balance = amount;
                    acc.type = document.getElementById('modal-provider').value;
                } else if (modalMode === 'debt') {
                    const d = appData.debts.find(x => x.id === editingId);
                    d.name = name;
                    d.amount = amount;
                    d.type = document.querySelector('input[name="debtType"]:checked').value;
                    d.phone = document.getElementById('modal-phone').value;
                    d.date = document.getElementById('modal-date').value;
                } else if (modalMode === 'gift') {
                    const g = appData.gifts.find(x => x.id === editingId);
                    g.name = name;
                    g.amount = amount;
                    g.date = document.getElementById('modal-date').value;
                }
            } 
            // CREATE NEW
            else {
                const id = Date.now();
                if (modalMode === 'wallet' || modalMode === 'invest') {
                    const type = document.getElementById('modal-provider').value;
                    appData.accounts.push({ id, name, type, balance: amount });
                } else if (modalMode === 'target') {
                    const goal = getRawValue('modal-goal-amount');
                    appData.targets.push({ id, name, current: amount, goal });
                } else if (modalMode === 'debt') {
                    const type = document.querySelector('input[name="debtType"]:checked').value;
                    const date = document.getElementById('modal-date').value;
                    const phone = document.getElementById('modal-phone').value;
                    appData.debts.unshift({ id, type, name, amount, date, phone });
                } else if (modalMode === 'gift') {
                    const date = document.getElementById('modal-date').value;
                    appData.gifts.unshift({ id, name, amount, date });
                }
            }

            saveData();
            closeModal();
            renderAssets(); renderTargets(); renderDebts(); renderGifts();
        }

        // --- UTILS & CORE ---
        function openTargetAction(id) {
            activeTargetId = id;
            document.getElementById('target-action-modal').classList.remove('hidden');
            document.getElementById('action-amount').value = '';
            document.getElementById('action-target-name').innerText = appData.targets.find(x => x.id === id).name;
        }

        function saveTargetProgress() {
            const amount = getRawValue('action-amount');
            const t = appData.targets.find(x => x.id === activeTargetId);
            if(t) { t.current += amount; saveData(); renderTargets(); document.getElementById('target-action-modal').classList.add('hidden'); }
        }

        function deleteItem(arrName, id) {
            if(confirm("Hapus data ini?")) {
                appData[arrName] = appData[arrName].filter(x => x.id !== id);
                saveData();
                renderAssets(); renderDebts(); renderGifts();
                if(arrName === 'targets') { renderTargets(); document.getElementById('target-action-modal').classList.add('hidden'); }
            }
        }

        function updateCash(key, delta) {
            const current = appData.cash[key] || 0;
            let next = current + delta;
            if (next < 0) next = 0;
            appData.cash[key] = next;
            renderCalculator();
            saveData();
        }

        function setCash(key, val) {
            let num = parseInt(val) || 0;
            if(num < 0) num = 0;
            appData.cash[key] = num;
            renderCalculator();
            saveData();
        }

        function calculateCashTotal() {
            let total = 0;
            denominations.forEach(d => total += (appData.cash[`${d.val}-${d.type}`] || 0) * d.val);
            document.getElementById('calc-total').innerText = formatRupiah(total);
            document.getElementById('dash-cash').innerText = formatRupiah(total);
            return total;
        }

        function updateSummary() {
            const cash = calculateCashTotal();
            const assets = appData.accounts.reduce((acc, curr) => acc + curr.balance, 0);
            const targets = appData.targets.reduce((acc, curr) => acc + curr.current, 0);
            const piutang = appData.debts.filter(d => d.type === 'lent').reduce((acc, curr) => acc + curr.amount, 0);
            const hutang = appData.debts.filter(d => d.type === 'borrowed').reduce((acc, curr) => acc + curr.amount, 0);
            
            // Net Worth Formula
            const netWorth = cash + assets + targets + piutang - hutang;
            document.getElementById('header-net-worth').innerText = formatRupiah(netWorth);
        }

        function getIcon(type, name) {
            if (name.toLowerCase().includes('bca')) return '<i class="fa-solid fa-building-columns text-blue-500"></i>';
            if (name.toLowerCase().includes('gopay')) return '<i class="fa-solid fa-wallet text-blue-400"></i>';
            if (type === 'crypto') return '<i class="fa-brands fa-bitcoin text-yellow-500"></i>';
            if (type === 'stock') return '<i class="fa-solid fa-chart-line text-green-500"></i>';
            if (type === 'gold') return '<i class="fa-solid fa-ring text-yellow-300"></i>';
            return '<i class="fa-solid fa-sack-dollar text-gray-400"></i>';
        }
        function translateType(t) { return { 'wallet': 'Dompet Digital', 'bank': 'Bank', 'stock': 'Saham', 'crypto': 'Crypto', 'gold': 'Emas' }[t] || t; }

        init();
    </script>
</body>
</html>
