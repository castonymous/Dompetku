<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>iFinance Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js untuk Grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&family=Inter:wght@400;600&display=swap');

        /* --- THEME CONFIG --- */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #000;
            color: white;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 110px;
            overscroll-behavior-y: none;
            -webkit-user-select: none; user-select: none;
            padding-top: env(safe-area-inset-top);
        }

        /* Allow text selection only in inputs */
        input, textarea { -webkit-user-select: text; user-select: text; }

        /* Fluid Background */
        .ambient-light {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1;
            background: radial-gradient(circle at 10% 20%, rgba(68, 55, 255, 0.4) 0%, transparent 40%),
                        radial-gradient(circle at 90% 80%, rgba(255, 48, 100, 0.3) 0%, transparent 40%),
                        radial-gradient(circle at 50% 50%, rgba(48, 207, 255, 0.2) 0%, transparent 60%);
            filter: blur(60px); animation: pulse 10s infinite alternate;
        }
        @keyframes pulse { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }

        /* Glass UI */
        .glass-panel { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .glass-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.2s; }
        .glass-card:active { transform: scale(0.98); background: rgba(255, 255, 255, 0.1); }
        .glass-input { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); color: white; width: 100%; outline: none; }
        .glass-input:focus { border-color: rgba(96, 165, 250, 0.5); background: rgba(0, 0, 0, 0.6); }

        /* Logo Brand Style */
        .brand-logo { width: 100%; height: 100%; object-fit: contain; border-radius: 50%; }
        .brand-bg { background: white; padding: 2px; } /* Background putih biar logo transparan kelihatan */

        /* Privacy Blur */
        .blur-amount { filter: blur(6px); user-select: none; }

        /* Segment Control & Dock */
        .segment-control { background: rgba(0,0,0,0.3); padding: 4px; border-radius: 12px; display: flex; margin-bottom: 15px; }
        .segment-btn { flex: 1; text-align: center; padding: 8px; font-size: 12px; font-weight: 600; border-radius: 8px; color: #9ca3af; transition: all 0.3s; }
        .segment-btn.active { background: rgba(255,255,255,0.15); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .dock { background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-top: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: max(15px, env(safe-area-inset-bottom)); }
        .nav-item { transition: all 0.3s; opacity: 0.5; }
        .nav-item.active { opacity: 1; transform: translateY(-2px); }
        .nav-item.active i { color: #60a5fa; text-shadow: 0 0 10px rgba(96, 165, 250, 0.6); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div class="ambient-light"></div>

    <!-- Header -->
    <header class="sticky top-0 z-40 pt-4 pb-2 px-5 glass-panel border-t-0 border-x-0 rounded-b-3xl mb-4">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-cyan-500 flex items-center justify-center shadow-lg shadow-indigo-500/30">
                    <i class="fa-brands fa-apple text-xl"></i>
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <h1 class="font-bold text-lg tracking-tight">iFinance</h1>
                        <button onclick="openSettings()" class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center text-[10px] text-gray-300 hover:bg-white/20 active:scale-90 transition">
                            <i class="fa-solid fa-gear"></i>
                        </button>
                    </div>
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest">Pro Edition</p>
                </div>
            </div>
            <div class="text-right">
                <div class="flex items-center justify-end gap-2 mb-1">
                    <p class="text-gray-400 text-xs">Total Net Worth</p>
                    <!-- PRIVACY TOGGLE BUTTON -->
                    <button onclick="togglePrivacy()" class="text-gray-500 hover:text-white transition">
                        <i id="privacy-icon" class="fa-solid fa-eye"></i>
                    </button>
                </div>
                <h2 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-300 to-cyan-300 amount-display" id="header-net-worth">Rp 0</h2>
            </div>
        </div>
    </header>

    <main class="px-4 min-h-screen">
        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="space-y-4 animate-fade-in">
            
            <!-- Quick Transactions -->
            <div class="flex gap-3 mb-2">
                <button onclick="openTransactionModal('in')" class="flex-1 bg-emerald-600/20 border border-emerald-500/30 py-3 rounded-xl flex items-center justify-center gap-2 hover:bg-emerald-600/30 active:scale-95 transition">
                    <div class="w-6 h-6 rounded-full bg-emerald-500 flex items-center justify-center text-white text-xs"><i class="fa-solid fa-arrow-down"></i></div><span class="text-sm font-bold text-emerald-100">Pemasukan</span>
                </button>
                <button onclick="openTransactionModal('out')" class="flex-1 bg-rose-600/20 border border-rose-500/30 py-3 rounded-xl flex items-center justify-center gap-2 hover:bg-rose-600/30 active:scale-95 transition">
                    <div class="w-6 h-6 rounded-full bg-rose-500 flex items-center justify-center text-white text-xs"><i class="fa-solid fa-arrow-up"></i></div><span class="text-sm font-bold text-rose-100">Pengeluaran</span>
                </button>
            </div>

            <!-- CHART CARD (NEW FEATURE) -->
            <div class="glass-card p-4 rounded-2xl flex flex-col items-center">
                <div class="flex justify-between w-full mb-2">
                    <h3 class="text-xs font-bold text-gray-400 uppercase">Komposisi Aset</h3>
                    <span class="text-[10px] bg-white/10 px-2 py-0.5 rounded text-gray-300">Live</span>
                </div>
                <div class="w-40 h-40 relative">
                    <canvas id="netWorthChart"></canvas>
                    <!-- Center Text -->
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <i class="fa-solid fa-wallet text-gray-600 text-2xl opacity-50"></i>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="glass-card p-3 rounded-2xl h-24 relative overflow-hidden group" onclick="switchTab('cash')">
                    <div class="absolute -right-2 -bottom-2 text-6xl text-emerald-500/10"><i class="fa-solid fa-money-bill"></i></div><p class="text-xs text-gray-400">Cash Fisik</p><p class="font-bold text-lg mt-1 amount-display" id="dash-cash">Rp 0</p>
                </div>
                <div class="glass-card p-3 rounded-2xl h-24 relative overflow-hidden group" onclick="switchTab('assets')">
                    <div class="absolute -right-2 -bottom-2 text-6xl text-blue-500/10"><i class="fa-solid fa-wallet"></i></div><p class="text-xs text-gray-400">Aset Digital</p><p class="font-bold text-lg mt-1 amount-display" id="dash-wallet">Rp 0</p>
                </div>
                <div class="glass-card p-3 rounded-2xl h-24 relative overflow-hidden group" onclick="switchTab('assets', 'invest')">
                    <div class="absolute -right-2 -bottom-2 text-6xl text-purple-500/10"><i class="fa-solid fa-chart-pie"></i></div><p class="text-xs text-gray-400">Investasi</p><p class="font-bold text-lg mt-1 amount-display" id="dash-invest">Rp 0</p>
                </div>
                <div class="glass-card p-3 rounded-2xl h-24 relative overflow-hidden group" onclick="switchTab('social')">
                    <div class="absolute -right-2 -bottom-2 text-6xl text-orange-500/10"><i class="fa-solid fa-handshake"></i></div><p class="text-xs text-gray-400">Piutang</p><p class="font-bold text-lg mt-1 amount-display" id="dash-receivable">Rp 0</p>
                </div>
            </div>
            <div class="glass-card p-3 rounded-2xl flex justify-between items-center" onclick="switchTab('social', 'gift')">
                <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-pink-500/20 flex items-center justify-center text-pink-400"><i class="fa-solid fa-envelope-open-text"></i></div><div><p class="text-xs text-gray-400">Total Amplop Keluar</p><p class="font-bold text-pink-200 amount-display" id="dash-gifts">Rp 0</p></div></div><i class="fa-solid fa-chevron-right text-xs text-gray-600"></i>
            </div>
            <div class="mt-4"><h3 class="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wider">Mutasi Terakhir</h3><div id="dashboard-transactions" class="space-y-2"></div></div>
        </div>

        <!-- VIEW: CASH -->
        <div id="view-cash" class="hidden space-y-5">
            <div class="glass-panel p-5 rounded-3xl text-center relative overflow-hidden">
                 <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 to-green-300"></div><p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Total Fisik</p><h2 class="text-3xl font-bold text-emerald-300 amount-display" id="calc-total">Rp 0</h2>
            </div>
            <div class="space-y-2" id="money-inputs"></div>
        </div>

        <!-- VIEW: ASSETS -->
        <div id="view-assets" class="hidden space-y-5">
            <div class="segment-control">
                <button onclick="switchAssetTab('wallet')" id="seg-wallet" class="segment-btn active">Dompet / Bank</button>
                <button onclick="switchAssetTab('invest')" id="seg-invest" class="segment-btn">Investasi</button>
            </div>
            <div id="asset-wallet-view" class="space-y-4">
                <div class="flex justify-between items-center px-1"><p class="text-xs text-gray-400">Liquid Assets</p><button onclick="openModal('wallet')" class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white hover:scale-110 transition"><i class="fa-solid fa-plus"></i></button></div><div id="wallet-list" class="space-y-3"></div>
            </div>
            <div id="asset-invest-view" class="hidden space-y-4">
                <div class="flex justify-between items-center px-1"><p class="text-xs text-gray-400">Growth Assets</p><button onclick="openModal('invest')" class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center text-white hover:scale-110 transition"><i class="fa-solid fa-plus"></i></button></div><div id="invest-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- VIEW: TARGETS -->
        <div id="view-target" class="hidden space-y-5">
            <div class="glass-panel p-4 rounded-2xl flex justify-between items-center"><div><h3 class="font-bold">Target Impian</h3><p class="text-xs text-gray-400">Goals</p></div><button onclick="openModal('target')" class="bg-white/10 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-white/20">+ Target</button></div>
            <div id="target-list" class="space-y-4 pb-10"></div>
        </div>

        <!-- VIEW: SOCIAL -->
        <div id="view-social" class="hidden space-y-5">
            <div class="segment-control">
                <button onclick="switchSocialTab('debt')" id="seg-debt" class="segment-btn active">Hutang</button>
                <button onclick="switchSocialTab('gift')" id="seg-gift" class="segment-btn">Kondangan</button>
            </div>
            <div id="social-debt-view" class="space-y-4">
                <div class="flex justify-between items-center px-1"><p class="text-xs text-gray-400">Catatan Pinjaman</p><button onclick="openModal('debt')" class="bg-white/10 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-white/20">+ Catat</button></div><div id="debt-list" class="space-y-3"></div>
            </div>
            <div id="social-gift-view" class="hidden space-y-4">
                <div class="flex justify-between items-center px-1"><p class="text-xs text-gray-400">Amplop Keluar</p><button onclick="openModal('gift')" class="bg-pink-500/20 text-pink-300 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-pink-500/30">+ Amplop</button></div><div id="gift-list" class="space-y-3"></div>
            </div>
        </div>
    </main>

    <!-- DOCK NAVIGATION -->
    <nav class="dock fixed bottom-0 left-0 right-0 px-2 pt-3 flex justify-around items-center z-50 rounded-t-3xl">
        <button onclick="switchTab('dashboard')" class="nav-item active flex flex-col items-center gap-1 w-1/5" id="nav-dashboard"><i class="fa-solid fa-house text-xl"></i><span class="text-[10px] font-medium">Home</span></button>
        <button onclick="switchTab('cash')" class="nav-item flex flex-col items-center gap-1 w-1/5" id="nav-cash"><i class="fa-solid fa-money-bill text-xl"></i><span class="text-[10px] font-medium">Cash</span></button>
        <button onclick="switchTab('assets')" class="nav-item flex flex-col items-center gap-1 w-1/5" id="nav-assets"><i class="fa-solid fa-wallet text-xl"></i><span class="text-[10px] font-medium">Aset</span></button>
        <button onclick="switchTab('target')" class="nav-item flex flex-col items-center gap-1 w-1/5" id="nav-target"><i class="fa-solid fa-bullseye text-xl"></i><span class="text-[10px] font-medium">Target</span></button>
        <button onclick="switchTab('social')" class="nav-item flex flex-col items-center gap-1 w-1/5" id="nav-social"><i class="fa-solid fa-users text-xl"></i><span class="text-[10px] font-medium">Sosial</span></button>
    </nav>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[70] flex items-end sm:items-center justify-center">
        <div class="glass-panel w-full sm:max-w-sm rounded-t-3xl sm:rounded-3xl p-6 transform transition-transform duration-300 scale-100">
            <div class="w-12 h-1 bg-gray-600 rounded-full mx-auto mb-6"></div>
            <h3 class="text-xl font-bold mb-4">Pengaturan Data</h3>
            <div class="space-y-4">
                <div class="bg-blue-900/20 border border-blue-800/50 p-3 rounded-xl"><p class="text-xs text-blue-200">Data tersimpan di HP ini.</p></div>
                <button onclick="exportData()" class="w-full py-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold flex items-center justify-center gap-3 shadow-lg shadow-blue-500/20"><i class="fa-solid fa-download"></i> Backup (Download)</button>
                <div class="relative"><button onclick="document.getElementById('import-file').click()" class="w-full py-4 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-bold flex items-center justify-center gap-3 shadow-lg shadow-emerald-500/20"><i class="fa-solid fa-file-import"></i> Restore (Upload)</button><input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)"></div>
                <hr class="border-white/10 my-2">
                <button onclick="resetData()" class="w-full py-3 rounded-xl bg-red-900/30 border border-red-800 text-red-400 font-bold hover:bg-red-900/50 flex items-center justify-center gap-2"><i class="fa-solid fa-trash"></i> Reset Data</button>
                <button onclick="closeSettings()" class="w-full py-3 rounded-xl bg-white/10 text-gray-400 font-semibold mt-2">Tutup</button>
            </div>
        </div>
    </div>

    <!-- FORM MODAL -->
    <div id="modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[60] flex items-end sm:items-center justify-center">
        <div class="glass-panel w-full sm:max-w-sm rounded-t-3xl sm:rounded-3xl p-6 transform transition-transform duration-300 scale-100">
            <div class="w-12 h-1 bg-gray-600 rounded-full mx-auto mb-6"></div>
            <h3 class="text-xl font-bold mb-4" id="modal-title">Form</h3>
            <div class="space-y-4 max-h-[70vh] overflow-y-auto no-scrollbar">
                <div id="field-debt-type" class="hidden mb-2">
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer"><input type="radio" name="debtType" value="lent" class="peer sr-only" checked><div class="glass-input p-3 rounded-xl text-center peer-checked:bg-emerald-600/50 peer-checked:border-emerald-500 border border-transparent"><span class="text-xs font-bold block">Dipinjam</span></div></label>
                        <label class="cursor-pointer"><input type="radio" name="debtType" value="borrowed" class="peer sr-only"><div class="glass-input p-3 rounded-xl text-center peer-checked:bg-red-600/50 peer-checked:border-red-500 border border-transparent"><span class="text-xs font-bold block">Saya Hutang</span></div></label>
                    </div>
                </div>
                <div id="field-name"><label class="text-xs text-gray-400 uppercase" id="label-name">Nama</label><input type="text" id="modal-name" class="glass-input p-3 rounded-xl mt-1"></div>
                <div id="field-provider" class="hidden"><label class="text-xs text-gray-400 uppercase">Kategori</label><select id="modal-provider" class="glass-input p-3 rounded-xl mt-1 bg-black text-white"></select></div>
                <div id="field-target-goal" class="hidden"><label class="text-xs text-gray-400 uppercase">Target Harga</label><input type="text" inputmode="numeric" id="modal-goal-amount" class="glass-input p-3 rounded-xl mt-1" oninput="formatInput(this)"></div>
                <div id="field-contact" class="hidden"><label class="text-xs text-gray-400 uppercase">No HP (WA)</label><input type="tel" id="modal-phone" class="glass-input p-3 rounded-xl mt-1"></div>
                <div id="field-date" class="hidden"><label class="text-xs text-gray-400 uppercase">Tanggal</label><input type="date" id="modal-date" class="glass-input p-3 rounded-xl mt-1 text-white" style="color-scheme: dark;"></div>
                <div id="field-amount"><label class="text-xs text-gray-400 uppercase" id="label-amount">Nominal</label><input type="text" inputmode="numeric" id="modal-amount" class="glass-input p-3 rounded-xl mt-1 font-bold text-lg" oninput="formatInput(this)"></div>
                <div class="flex gap-3 mt-6"><button onclick="closeModal()" class="flex-1 py-3 rounded-xl bg-white/10 text-gray-300">Batal</button><button onclick="saveModalData()" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold" id="btn-save-modal">Simpan</button></div>
            </div>
        </div>
    </div>

    <!-- TRANSACTION MODAL -->
    <div id="trx-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[65] flex items-end sm:items-center justify-center">
        <div class="glass-panel w-full sm:max-w-sm rounded-t-3xl sm:rounded-3xl p-6">
            <h3 class="text-lg font-bold mb-4" id="trx-title">Transaksi</h3>
            <div class="space-y-4">
                <div><label class="text-xs text-gray-400 uppercase">Sumber Dana</label><select id="trx-source" class="glass-input p-3 rounded-xl mt-1 bg-black text-white"></select><p class="text-[10px] text-gray-500 mt-1">*Saldo akun berubah otomatis.</p></div>
                <div><label class="text-xs text-gray-400 uppercase">Keterangan</label><input type="text" id="trx-note" class="glass-input p-3 rounded-xl mt-1"></div>
                <div><label class="text-xs text-gray-400 uppercase">Nominal</label><input type="text" inputmode="numeric" id="trx-amount" class="glass-input p-3 rounded-xl mt-1 font-bold text-lg" oninput="formatInput(this)"></div>
                <div class="flex gap-3 mt-4"><button onclick="closeTrxModal()" class="flex-1 py-3 rounded-xl bg-white/10 text-gray-400">Batal</button><button onclick="saveTransaction()" class="flex-1 py-3 rounded-xl bg-emerald-600 text-white font-bold" id="btn-save-trx">Simpan</button></div>
            </div>
        </div>
    </div>

    <!-- TARGET ACTION MODAL -->
    <div id="target-action-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[65] flex items-end sm:items-center justify-center">
        <div class="glass-panel w-full sm:max-w-sm rounded-t-3xl sm:rounded-3xl p-6">
             <h3 class="text-lg font-bold mb-2" id="action-target-name">Target</h3>
             <input type="text" inputmode="numeric" id="action-amount" class="glass-input p-3 rounded-xl mb-4" placeholder="Jumlah Nabung" oninput="formatInput(this)">
             <div class="grid grid-cols-2 gap-3"><button onclick="deleteItem('targets', activeTargetId)" class="py-3 rounded-xl bg-red-500/20 text-red-400">Hapus</button><button onclick="saveTargetProgress()" class="py-3 rounded-xl bg-emerald-600 text-white font-bold">Nabung</button></div>
             <button onclick="document.getElementById('target-action-modal').classList.add('hidden')" class="w-full mt-3 py-2 text-gray-500 text-sm">Batal</button>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        let appData = { cash: {}, accounts: [], targets: [], debts: [], gifts: [], transactions: [] };
        let editingId = null; let activeTargetId = null; let trxType = 'out'; let modalMode = '';
        let privacyMode = false;
        let chartInstance = null;

        const denominations = [
            { val: 100000, label: '100K', color: 'text-emerald-400' }, { val: 50000, label: '50K', color: 'text-blue-400' },
            { val: 20000, label: '20K', color: 'text-emerald-400' }, { val: 10000, label: '10K', color: 'text-purple-400' },
            { val: 5000, label: '5K', color: 'text-yellow-400' }, { val: 2000, label: '2K', color: 'text-gray-400' },
            { val: 1000, label: '1K Kertas', color: 'text-emerald-400' }, { val: 1000, label: '1K Koin', color: 'text-yellow-400' },
            { val: 500, label: '500', color: 'text-gray-400' }, { val: 200, label: '200', color: 'text-gray-400' }, { val: 100, label: '100', color: 'text-gray-400' }
        ];

        // --- INIT ---
        function init() {
            const saved = localStorage.getItem('iFinancePro');
            if (saved) { appData = JSON.parse(saved); if(!appData.transactions) appData.transactions = []; }
            else { const old = localStorage.getItem('iFinanceUltimate'); if(old) appData = { ...appData, ...JSON.parse(old) }; }
            document.getElementById('modal-date').valueAsDate = new Date();
            renderAll();
        }
        function saveData() { localStorage.setItem('iFinancePro', JSON.stringify(appData)); updateSummary(); updateChart(); }
        function renderAll() { renderCalculator(); renderAssets(); renderTargets(); renderDebts(); renderGifts(); renderTrx(); updateSummary(); updateChart(); }

        // --- UTILS ---
        function formatInput(input) { let val = input.value.replace(/\D/g, ''); input.value = val ? new Intl.NumberFormat('id-ID').format(val) : ''; }
        function getRawValue(inputOrId) { const el = typeof inputOrId==='string'?document.getElementById(inputOrId):inputOrId; return parseInt(el.value.replace(/\./g, '')) || 0; }
        function formatRupiah(num) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num); }
        function translateType(t) { return { 'wallet': 'Dompet Digital', 'bank': 'Bank', 'stock': 'Saham', 'crypto': 'Crypto', 'gold': 'Emas' }[t] || t; }

        // --- NEW FEATURES: PRIVACY & CHART ---
        function togglePrivacy() {
            privacyMode = !privacyMode;
            const displays = document.querySelectorAll('.amount-display');
            const icon = document.getElementById('privacy-icon');
            if(privacyMode) {
                displays.forEach(el => el.classList.add('blur-amount'));
                icon.className = "fa-solid fa-eye-slash";
            } else {
                displays.forEach(el => el.classList.remove('blur-amount'));
                icon.className = "fa-solid fa-eye";
            }
        }

        function updateChart() {
            const ctx = document.getElementById('netWorthChart');
            if(!ctx) return;

            const cash = calculateCashTotal();
            const wallet = appData.accounts.filter(a => !['stock','crypto','gold','invest'].includes(a.type)).reduce((a,c)=>a+c.balance,0);
            const invest = appData.accounts.filter(a => ['stock','crypto','gold','invest'].includes(a.type)).reduce((a,c)=>a+c.balance,0);
            const lent = appData.debts.filter(d => d.type === 'lent').reduce((a,c)=>a+c.amount,0);

            const data = [cash, wallet, invest, lent];
            const labels = ['Cash', 'Dompet', 'Investasi', 'Piutang'];
            
            if(chartInstance) {
                chartInstance.data.datasets[0].data = data;
                chartInstance.update();
            } else {
                chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: ['#10b981', '#3b82f6', '#a855f7', '#f97316'],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '75%',
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }

        // --- REAL LOGO LOGIC ---
        function getIcon(type, name) {
            const n = name.toLowerCase();
            const logos = {
                'gopay': 'https://upload.wikimedia.org/wikipedia/commons/8/86/Gopay_logo.svg',
                'shopee': 'https://upload.wikimedia.org/wikipedia/commons/f/fe/Shopee.svg',
                'ovo': 'https://upload.wikimedia.org/wikipedia/commons/e/e6/OVO_logo.svg',
                'dana': 'https://upload.wikimedia.org/wikipedia/commons/7/72/Logo_dana_blue.svg',
                'bca': 'https://upload.wikimedia.org/wikipedia/commons/5/5c/Bank_Central_Asia.svg',
                'bri': 'https://upload.wikimedia.org/wikipedia/commons/6/68/BANK_BRI_logo.svg',
                'mandiri': 'https://upload.wikimedia.org/wikipedia/commons/a/ad/Bank_Mandiri_logo_2016.svg',
                'bni': 'https://upload.wikimedia.org/wikipedia/id/5/55/BNI_logo.svg',
                'jago': 'https://upload.wikimedia.org/wikipedia/commons/d/d1/Bank_Jago_logo.svg',
                'seabank': 'https://upload.wikimedia.org/wikipedia/commons/0/0e/SeaBank_logo.svg',
                'bitcoin': 'https://upload.wikimedia.org/wikipedia/commons/4/46/Bitcoin.svg',
                'linkaja': 'https://upload.wikimedia.org/wikipedia/commons/8/85/LinkAja.svg'
            };

            for (const [key, url] of Object.entries(logos)) {
                if (n.includes(key)) {
                    return `<div class="w-10 h-10 rounded-full bg-white flex items-center justify-center p-1 overflow-hidden shadow-sm"><img src="${url}" class="brand-logo" alt="${key}"></div>`;
                }
            }

            // Fallback Icons
            if (type === 'crypto') return '<div class="w-10 h-10 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-500 text-lg"><i class="fa-brands fa-bitcoin"></i></div>';
            if (type === 'stock') return '<div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-500 text-lg"><i class="fa-solid fa-chart-line"></i></div>';
            if (type === 'gold') return '<div class="w-10 h-10 rounded-full bg-yellow-300/20 flex items-center justify-center text-yellow-300 text-lg"><i class="fa-solid fa-ring"></i></div>';
            if (n.includes('bank')) return '<div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-500 text-lg"><i class="fa-solid fa-building-columns"></i></div>';
            
            return '<div class="w-10 h-10 rounded-full bg-gray-500/20 flex items-center justify-center text-gray-400 text-lg"><i class="fa-solid fa-sack-dollar"></i></div>';
        }

        // --- NAVIGATION & VIEWS ---
        function switchTab(viewName, subTab = null) {
            ['dashboard', 'cash', 'assets', 'target', 'social'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                document.getElementById(`nav-${v}`).classList.remove('active');
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            document.getElementById(`nav-${viewName}`).classList.add('active');
            if (viewName === 'assets' && subTab) switchAssetTab(subTab);
            else if (viewName === 'social' && subTab) switchSocialTab(subTab);
        }
        function switchAssetTab(tab) {
            document.getElementById('asset-wallet-view').classList.add('hidden'); document.getElementById('asset-invest-view').classList.add('hidden');
            document.getElementById('seg-wallet').classList.remove('active'); document.getElementById('seg-invest').classList.remove('active');
            document.getElementById(`asset-${tab}-view`).classList.remove('hidden'); document.getElementById(`seg-${tab}`).classList.add('active');
        }
        function switchSocialTab(tab) {
            document.getElementById('social-debt-view').classList.add('hidden'); document.getElementById('social-gift-view').classList.add('hidden');
            document.getElementById('seg-debt').classList.remove('active'); document.getElementById('seg-gift').classList.remove('active');
            document.getElementById(`social-${tab}-view`).classList.remove('hidden'); document.getElementById(`seg-${tab}`).classList.add('active');
        }

        // --- EXPORT/IMPORT ---
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            const dlNode = document.createElement('a'); dlNode.setAttribute("href", dataStr); dlNode.setAttribute("download", "ifinance_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(dlNode); dlNode.click(); dlNode.remove();
        }
        function importData(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try { const dat = JSON.parse(e.target.result); if(dat.cash && dat.accounts) { if(confirm("Restore data?")) { appData = dat; saveData(); renderAll(); alert("Sukses!"); closeSettings(); } } else alert("File salah!"); } catch(e) { alert("File rusak!"); }
            }; reader.readAsText(file); input.value = '';
        }
        function resetData() { if(confirm("Reset SEMUA data?")) { localStorage.removeItem('iFinancePro'); location.reload(); } }

        // --- MODAL & FORM ---
        function openModal(mode, editId = null) {
            modalMode = mode; editingId = editId; document.getElementById('modal').classList.remove('hidden');
            ['field-provider','field-debt-type','field-contact','field-date','field-target-goal'].forEach(id=>document.getElementById(id).classList.add('hidden'));
            document.getElementById('modal-name').value=''; document.getElementById('modal-amount').value='';
            
            let title='', ex=null;
            if(editId) ex = (mode==='wallet'||mode==='invest')?appData.accounts.find(x=>x.id==editId):(mode==='debt')?appData.debts.find(x=>x.id==editId):(mode==='gift')?appData.gifts.find(x=>x.id==editId):appData.targets.find(x=>x.id==editId);
            
            if(ex) { document.getElementById('modal-name').value=ex.name; document.getElementById('modal-amount').value=new Intl.NumberFormat('id-ID').format(ex.amount||ex.balance||ex.current); }

            if(mode==='wallet'||mode==='invest') {
                title=editId?"Edit Akun":"Tambah Akun"; document.getElementById('field-provider').classList.remove('hidden');
                const s=document.getElementById('modal-provider'); s.innerHTML=mode==='wallet'?'<option value="wallet">Dompet Digital</option><option value="bank">Bank</option>':'<option value="stock">Saham</option><option value="crypto">Crypto</option><option value="gold">Emas</option>';
                if(ex) s.value=ex.type;
            } else if(mode==='debt') {
                title="Hutang / Piutang"; document.getElementById('field-debt-type').classList.remove('hidden'); document.getElementById('field-contact').classList.remove('hidden'); document.getElementById('field-date').classList.remove('hidden');
                if(ex) { document.getElementById('modal-phone').value=ex.phone; document.getElementById('modal-date').value=ex.date; document.querySelector(`input[name="debtType"][value="${ex.type}"]`).checked=true; }
            } else if(mode==='target') {
                title="Target Impian"; document.getElementById('field-target-goal').classList.remove('hidden'); if(ex) document.getElementById('modal-goal-amount').value=new Intl.NumberFormat('id-ID').format(ex.goal);
            } else if(mode==='gift') {
                title="Amplop"; document.getElementById('field-date').classList.remove('hidden'); if(ex) document.getElementById('modal-date').value=ex.date;
            }
            document.getElementById('modal-title').innerText=title;
        }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        function saveModalData() {
            const name=document.getElementById('modal-name').value; const amt=getRawValue('modal-amount');
            if(!name) return alert("Nama wajib!");
            if(editingId) {
                if(modalMode==='wallet'||modalMode==='invest') { const a=appData.accounts.find(x=>x.id==editingId); a.name=name; a.balance=amt; a.type=document.getElementById('modal-provider').value; }
                else if(modalMode==='debt') { const d=appData.debts.find(x=>x.id==editingId); d.name=name; d.amount=amt; d.type=document.querySelector('input[name="debtType"]:checked').value; d.phone=document.getElementById('modal-phone').value; d.date=document.getElementById('modal-date').value; }
                else if(modalMode==='gift') { const g=appData.gifts.find(x=>x.id==editingId); g.name=name; g.amount=amt; g.date=document.getElementById('modal-date').value; }
            } else {
                const id=Date.now();
                if(modalMode==='wallet'||modalMode==='invest') appData.accounts.push({id,name,type:document.getElementById('modal-provider').value,balance:amt});
                else if(modalMode==='target') appData.targets.push({id,name,current:amt,goal:getRawValue('modal-goal-amount')});
                else if(modalMode==='debt') appData.debts.unshift({id,type:document.querySelector('input[name="debtType"]:checked').value,name,amount:amt,date:document.getElementById('modal-date').value,phone:document.getElementById('modal-phone').value});
                else if(modalMode==='gift') appData.gifts.unshift({id,name,amount:amt,date:document.getElementById('modal-date').value});
            }
            saveData(); closeModal(); renderAll();
        }

        // --- LIST RENDERERS ---
        function renderAssets() {
            const w=document.getElementById('wallet-list'); const i=document.getElementById('invest-list'); w.innerHTML=''; i.innerHTML=''; let wt=0, it=0;
            appData.accounts.forEach(a => {
                const inv = ['stock','crypto','gold','invest'].includes(a.type);
                const h = `<div class="glass-card p-4 rounded-xl flex justify-between items-center group relative"><div class="flex items-center gap-3">${getIcon(a.type, a.name)}<div><p class="font-bold">${a.name}</p><p class="text-xs text-gray-400 capitalize">${translateType(a.type)}</p></div></div><div class="text-right"><p class="font-bold ${inv?'text-purple-300':'text-blue-300'} amount-display">${formatRupiah(a.balance)}</p><div class="flex justify-end gap-3 mt-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="openModal('${inv?'invest':'wallet'}', ${a.id})" class="text-xs text-blue-400"><i class="fa-solid fa-pen"></i></button><button onclick="deleteItem('accounts', ${a.id})" class="text-xs text-red-400"><i class="fa-solid fa-trash"></i></button></div></div></div>`;
                if(inv){i.innerHTML+=h; it+=a.balance;} else {w.innerHTML+=h; wt+=a.balance;}
            });
            document.getElementById('dash-wallet').innerText=formatRupiah(wt); document.getElementById('dash-invest').innerText=formatRupiah(it);
        }
        function renderCalculator() {
            const c=document.getElementById('money-inputs'); c.innerHTML='';
            denominations.forEach(d=>{
                const k=`${d.val}-${d.type}`; const count=appData.cash[k]||0;
                c.innerHTML+=`<div class="glass-card p-3 rounded-xl flex items-center justify-between gap-3"><div class="flex flex-col flex-1 min-w-0"><span class="font-bold ${d.color} text-lg truncate">${d.label}</span></div><div class="flex items-center gap-1 bg-black/30 rounded-lg p-1"><button onclick="updateCash('${k}',-1)" class="w-10 h-10 rounded-lg bg-white/10 active:bg-white/20 font-bold">-</button><input type="number" value="${count||''}" placeholder="0" class="w-16 bg-transparent text-center font-bold text-white focus:outline-none text-lg" onchange="setCash('${k}',this.value)"><button onclick="updateCash('${k}',1)" class="w-10 h-10 rounded-lg bg-white/10 active:bg-white/20 font-bold">+</button></div></div>`;
            });
            calculateCashTotal();
        }
        function renderTargets() {
            const l=document.getElementById('target-list'); l.innerHTML='';
            if(appData.targets.length===0) l.innerHTML='<p class="text-center text-gray-500 text-xs mt-10">Mulai buat impian pertamamu!</p>';
            appData.targets.forEach(t => {
                const pct = Math.min(100, (t.current/t.goal)*100);
                l.innerHTML += `<div class="glass-card p-4 rounded-xl cursor-pointer hover:bg-white/10" onclick="openTargetAction(${t.id})"><div class="flex justify-between items-end mb-2"><h4 class="font-bold truncate pr-4">${t.name}</h4><span class="text-xs text-blue-400 font-bold">${Math.round(pct)}%</span></div><div class="w-full bg-gray-700/50 h-2 rounded-full overflow-hidden mb-2"><div class="h-full bg-blue-500" style="width:${pct}%"></div></div><div class="flex justify-between text-[10px] text-gray-400"><span class="amount-display">${formatRupiah(t.current)}</span><span class="amount-display">Target: ${formatRupiah(t.goal)}</span></div></div>`;
            });
        }
        function renderDebts() {
            const l=document.getElementById('debt-list'); l.innerHTML=''; let rt=0;
            appData.debts.forEach(d => {
                const lent=d.type==='lent'; if(lent)rt+=d.amount;
                let wa = d.phone?`<a href="https://wa.me/${d.phone.replace(/^0/,'62').replace(/\D/g,'')}" target="_blank" class="w-8 h-8 rounded-full bg-green-600/20 flex items-center justify-center text-green-400"><i class="fa-brands fa-whatsapp"></i></a>`:'';
                l.innerHTML+=`<div class="glass-card p-4 rounded-xl flex flex-col gap-2 group relative overflow-hidden"><div class="absolute left-0 top-0 bottom-0 w-1 ${lent?'bg-emerald-500':'bg-red-500'}"></div><div class="flex justify-between items-start pl-2"><div><div class="flex items-center gap-2"><h4 class="font-bold">${d.name}</h4><span class="text-[10px] px-2 py-0.5 rounded ${lent?'bg-emerald-500/20 text-emerald-300':'bg-red-500/20 text-red-300'}">${lent?'Dipinjam':'Hutang'}</span></div><p class="text-xs text-gray-400 mt-1">${new Date(d.date).toLocaleDateString('id-ID',{day:'numeric',month:'short'})}</p></div><div class="text-right"><p class="font-bold ${lent?'text-emerald-400':'text-red-400'} amount-display">${formatRupiah(d.amount)}</p><div class="flex justify-end gap-3 mt-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="openModal('debt',${d.id})" class="text-xs text-blue-400"><i class="fa-solid fa-pen"></i></button><button onclick="deleteItem('debts',${d.id})" class="text-xs text-red-400"><i class="fa-solid fa-check"></i></button></div></div></div>${wa?`<div class="flex justify-end pt-2 border-t border-white/10 mt-1 gap-2 items-center"><span class="text-[10px] text-gray-500">Tagih:</span>${wa}</div>`:''}</div>`;
            });
            document.getElementById('dash-receivable').innerText=formatRupiah(rt);
        }
        function renderGifts() {
            const l=document.getElementById('gift-list'); l.innerHTML=''; let gt=0;
            appData.gifts.forEach(g => { gt+=g.amount;
                l.innerHTML+=`<div class="glass-card p-3 rounded-xl flex items-center gap-3 group relative"><div class="w-10 h-10 rounded-full bg-pink-500/20 flex items-center justify-center text-pink-300"><i class="fa-solid fa-gift"></i></div><div class="flex-1"><p class="font-bold">${g.name}</p><p class="text-xs text-gray-400">${new Date(g.date).toLocaleDateString('id-ID',{day:'numeric',month:'short'})}</p></div><div class="text-right"><p class="font-bold text-pink-300 amount-display">${formatRupiah(g.amount)}</p><div class="flex justify-end gap-3 mt-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="openModal('gift',${g.id})" class="text-xs text-blue-400">Edit</button><button onclick="deleteItem('gifts',${g.id})" class="text-xs text-red-400">Hapus</button></div></div></div>`;
            });
            document.getElementById('dash-gifts').innerText=formatRupiah(gt);
        }
        function renderTrx() {
            const c=document.getElementById('dashboard-transactions'); c.innerHTML='';
            appData.transactions.slice(0,3).forEach(t=>{ c.innerHTML+=`<div class="flex justify-between items-center py-2 border-b border-white/5 last:border-0"><div><p class="text-sm font-bold text-gray-200">${t.note}</p><p class="text-[10px] text-gray-500">${t.sourceLabel}</p></div><p class="text-sm font-bold ${t.type==='out'?'text-rose-400':'text-emerald-400'} amount-display">${t.type==='out'?'-':'+'} ${formatRupiah(t.amount)}</p></div>`; });
        }

        // --- SUB UTILS ---
        function updateCash(k,d) { const curr=appData.cash[k]||0; appData.cash[k]=curr+d<0?0:curr+d; renderCalculator(); saveData(); }
        function setCash(k,v) { const num=parseInt(v)||0; appData.cash[k]=num<0?0:num; renderCalculator(); saveData(); }
        function calculateCashTotal() { let t=0; denominations.forEach(d=>t+=(appData.cash[`${d.val}-${d.type}`]||0)*d.val); document.getElementById('calc-total').innerText=formatRupiah(t); document.getElementById('dash-cash').innerText=formatRupiah(t); return t; }
        function updateSummary() {
            const cash=calculateCashTotal(); const assets=appData.accounts.reduce((a,c)=>a+c.balance,0); const targets=appData.targets.reduce((a,c)=>a+c.current,0);
            const lent=appData.debts.filter(d=>d.type==='lent').reduce((a,c)=>a+c.amount,0); const borrow=appData.debts.filter(d=>d.type==='borrowed').reduce((a,c)=>a+c.amount,0);
            document.getElementById('header-net-worth').innerText=formatRupiah(cash+assets+targets+lent-borrow);
            if(privacyMode) { document.querySelectorAll('.amount-display').forEach(el => el.classList.add('blur-amount')); }
        }
        function openTargetAction(id) { activeTargetId=id; document.getElementById('target-action-modal').classList.remove('hidden'); document.getElementById('action-amount').value=''; document.getElementById('action-target-name').innerText=appData.targets.find(x=>x.id==id).name; }
        function saveTargetProgress() { const amt=getRawValue('action-amount'); const t=appData.targets.find(x=>x.id==activeTargetId); if(t){t.current+=amt;saveData();renderAll();document.getElementById('target-action-modal').classList.add('hidden');} }
        function deleteItem(arr,id) { if(confirm("Hapus data ini?")) { appData[arr]=appData[arr].filter(x=>x.id!==id); saveData(); renderAll(); if(arr==='targets')document.getElementById('target-action-modal').classList.add('hidden'); } }
        function openTransactionModal(t) { trxType=t; document.getElementById('trx-modal').classList.remove('hidden'); document.getElementById('trx-title').innerText=t==='in'?"Pemasukan":"Pengeluaran"; document.getElementById('btn-save-trx').className=`flex-1 py-3 rounded-xl text-white font-bold ${t==='in'?'bg-emerald-600':'bg-rose-600'}`; const s=document.getElementById('trx-source'); s.innerHTML='<option value="cash">Cash (Uang Fisik)</option>'; appData.accounts.forEach(a=>s.innerHTML+=`<option value="${a.id}">${a.name} (${translateType(a.type)})</option>`); document.getElementById('trx-amount').value=''; document.getElementById('trx-note').value=''; }
        function closeTrxModal() { document.getElementById('trx-modal').classList.add('hidden'); }
        function saveTransaction() {
            const amt=getRawValue('trx-amount'); const note=document.getElementById('trx-note').value||(trxType==='in'?'Pemasukan':'Pengeluaran'); const src=document.getElementById('trx-source').value;
            if(amt<=0)return alert("Nominal > 0"); let lbl='Cash';
            if(src!=='cash'){ const acc=appData.accounts.find(a=>a.id==src); if(acc){ lbl=acc.name; if(trxType==='out')acc.balance-=amt; else acc.balance+=amt; } }
            appData.transactions.unshift({id:Date.now(),date:new Date().toISOString(),type:trxType,amount:amt,note,sourceId:src,sourceLabel:lbl});
            saveData(); renderAll(); closeTrxModal();
        }

        init();
    </script>
</body>
</html>
